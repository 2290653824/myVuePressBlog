https://articles.zsxq.com/id_d912swekk0we.html


## kafka如何存储数据
首先，kafka是一个流式处理平台，会有很多的数据源源不断地向kafka发送数据，所有会有大量的数据存放到kafka中。如果我们将说句存放到内存中，这肯定是不行的很有可能会造成oom。所以我们最开始的目标肯定是将数据放在磁盘中。



那么如果存放在磁盘中，消费者要进行消费，从磁盘中取出数据会不会非常慢呢？

![image-20230818101440479](https://2290653824-github-io.oss-cn-hangzhou.aliyuncs.com/image-20230818101440479.png)

这么看来，想要实现磁盘的读取速率和磁盘相当，一个很好的办法就是在磁盘中采用顺序读写，这时就可以用到日志log，日志log就是采用顺序读写的方式。



## 从kafka特性看存储特性

kakfa操作有哪些特性呢？

1. 写操作：写并发要求非常高，基本得达到百万级 TPS，顺序追加写日志即可，无需考虑更新操
    作
2. 读操作：相对写操作来说，比较简单，只要能按照一定规则高效查询即可 (offset或者时间
    戳）



对于写操作，因为我们才用的顺序写入，速度还是比较快的，可以和内存操作相媲美。

对于查询操作，我们想要从海量的数据中找到我们想要的offset，这个时候肯定是要用到索引的。那么应该用哪种索引呢？



### b+树

 B+树索引需要维护平衡，保持树的结构。在插入和删除数据时，可能需要对树进行重排和平衡操作，确保树的高度不会过高，从而保持搜索性能。这涉及到节点的拆分和合并，可能会导致频繁的磁盘读写。

如果使用B+树，那么每次写入操作都要维护这个索引，还需要有额外的空间来存储这个索引，还有可能会出现“数据页分裂”等操作，对于kafka这种高并发写操作，设计太重了，所以并不适用。



那么有没有什么索引没有那么高的维护成本呢？可以试试hash索引

### hash

我们可以在内存中维护一个map结构，key为offset，value为对应的offset在日志中的物理日志。
















## kafka日志结构


## kafka中的稀疏索引

## kafka的日志内容
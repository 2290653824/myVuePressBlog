---
title: DNS详细过程
date: 2023-02-13 19:57:12
permalink: /pages/ba3d4d/
categories:
  - 计算机基础
  - 计算机网络
tags:
  - 
author: 
  name: xugaoyi
  link: https://github.com/xugaoyi
---



## DNS 是什么



使用域名，人们可以将复杂的IP地址通过域名来记忆。DNS可以将域名网址自动转换为具体的ip地址。



DNS以逗号进行分割，代表了不同层次之间的界限。**其中越靠右边的位置所表示的层级越高**

## DNS 分层



域名层级呈现一个树的结构。最高处叫做根域名。根域名的下一次就是顶级域名(eg:com)

具体如下：

- 根 DNS 服务器
- 顶级域 DNS 服务器（com）
- 权威 DNS 服务器（server.com）

![image-20230406210949582](https://2290653824-github-io.oss-cn-hangzhou.aliyuncs.com/undefinedimage-20230406210949582.png)

![image-20230406205443623](https://2290653824-github-io.oss-cn-hangzhou.aliyuncs.com/undefinedimage-20230406205443623.png)

根域的 DNS 服务器信息保存在互联网中所有的 DNS 服务器中。这样一来，任何 DNS 服务器就都可以找到并访问根域 DNS 服务器了。

因此，客户端只要能够找到任意一台 DNS 服务器，就可以通过它找到根域 DNS 服务器，然后再一路顺藤摸瓜找到位于下层的某台目标 DNS 服务器。





## DNS流程

浏览器首先看一下自己的缓存里有没有域名与地址的映射关系，如果没有就向操作系统的缓存要，还没有就检查本机域名解析文件 `hosts`，如果还是没有，就会 DNS 服务器进行查询，查询的过程如下：

1. 客户端首先会发出一个 DNS 请求，问 www.server.com 的 IP 是啥，并发给本地 DNS 服务器（也就是客户端的 TCP/IP 设置中填写的 DNS 服务器地址）。
2. 本地域名服务器收到客户端的请求后，如果缓存里的表格能找到 www.server.com，则它直接返回 IP 地址。如果没有，本地 DNS 会去问它的根域名服务器：“老大， 能告诉我 www.server.com 的 IP 地址吗？” 根域名服务器是最高层次的，它不直接用于域名解析，但能指明一条道路。
3. 根 DNS 收到来自本地 DNS 的请求后，发现后置是 .com，说：“www.server.com 这个域名归 .com 区域管理”，我给你 .com 顶级域名服务器地址给你，你去问问它吧。”
4. 本地 DNS 收到顶级域名服务器的地址后，发起请求问“老二， 你能告诉我 www.server.com 的 IP 地址吗？”
5. 顶级域名服务器说：“我给你负责 www.server.com 区域的权威 DNS 服务器的地址，你去问它应该能问到”。
6. 本地 DNS 于是转向问权威 DNS 服务器：“老三，www.server.com对应的IP是啥呀？” server.com 的权威 DNS 服务器，它是域名解析结果的原出处。为啥叫权威呢？就是我的域名我做主。
7. 权威 DNS 服务器查询后将对应的 IP 地址 X.X.X.X 告诉本地 DNS。
8. 本地 DNS 再将 IP 地址返回客户端，客户端和目标建立连接。



以上流程是以迭代的方式进行的。

![image-20230406210617385](https://2290653824-github-io.oss-cn-hangzhou.aliyuncs.com/undefinedimage-20230406210617385.png)

还有一种方式是通过递归的方式进行的。

​	当局部DNS服务器自己不能回答客户机的DNS查询时，它就需要向其他DNS服务器进行查询。此时有两种方式，如图所示的是递归方式。局部DNS服务器自己负责向其他DNS服务器进行查询，一般是先向该域名的根域服务器查询，再由根域名服务器一级级向下查询。最后得到的查询结果返回给局部DNS服务器，再由局部DNS服务器返回给客户端。



## 迭代和递归的区别

**递归**：客户端只发一次请求，要求对方给出最终结果。返回的结果只有两种：查询成功或查询失败。
**迭代**：又称为“重指引”。客户端发出一次请求，对方如果没有**授权回答**（向dns服务器查询一个域名，刚好这个域名是本服务器负责，返回的结果就是授权回答），它就会返回一个能解答这个查询的其它名称服务器列表，客户端会再向返回的列表中发出请求，直到找到最终负责所查域名的名称服务器，从它得到最终结果。
**客户端-本地dns服务端**：这部分属于**递归**查询。
**本地dns服务端-外网**：这部分属于**迭代**查询。（不启用转发模式）



## 关于dig命令

dig @server name type

@server: 指定域名服务器
name:指定查询请求资源的域名
type:指定查询类型，如A、CNAME、SRV、MX、SIG等，如果不指定type，默认为A

查询某个域名解析的全过程:(此时为迭代查询)
$ dig @8.8.8.8  163.com +trace

[https://developer.aliyun.com/article/418787](https://developer.aliyun.com/article/418787)

---
title: ICMP
date: 2023-04-03 23:25:36
permalink: /pages/da7840/
categories:
  - 计算机基础
  - 计算机网络
tags:
  - 
author: 
  name: xugaoyi
  link: https://github.com/xugaoyi
---


## ICMP

Internet Control Message Protocol 网络控制报文协议

关键字：控制

在网络层当中，一条数据包发送出去过后，我怎么知道这个数据是否发送成功还是发送失败？发送失败错误原因是什么呢？就像我们前端调用后端接口，前端调用后总有个返回信息说明请求成功或者错误原因吧。







## 功能

确认IP包是否成功发送到目的地址、报告发送过程中IP包被抛弃的原因和改善网络的设置等。

> 在ip通信过程中，如果某个ip包因为某种原因没有成功到达目的地，那么这个失败的原因就由ICMP来负责通知给发送方。



![image-20230403233740085](https://2290653824-github-io.oss-cn-hangzhou.aliyuncs.com/undefinedimage-20230403233740085.png)

解析：

如上图例子，主机 `A` 向主机 `B` 发送了数据包，由于某种原因，途中的路由器 `2` 未能发现主机 `B` 的存在，这时，路由器 `2` 就会向主机 `A` 发送一个 `ICMP` 目标不可达数据包，说明发往主机 `B` 的包未能成功。

ICMP 的这种通知消息会使用 `IP` 进行发送 。

因此，从路由器 `2` 返回的 ICMP 包会按照往常的路由控制先经过路由器 `1` 再转发给主机 `A` 。收到该 ICMP 包的主机 `A` 则分解 ICMP 的首部和数据域以后得知具体发生问题的原因。





## ICMP 类型

- 一类是用于诊断的查询消息，也就是「**查询报文类型**」
- 另一类是通知出错原因的错误消息，也就是「**差错报文类型**」

![image-20230403233942152](https://2290653824-github-io.oss-cn-hangzhou.aliyuncs.com/undefinedimage-20230403233942152.png)

## 报文结构

```shell
+-----------------------------------------------------------------------+
|              ICMP报文头部（固定长度8字节）                             |
+-----------------------------------------------------------------------+
|                            数据数据...                               |
+-----------------------------------------------------------------------+
```

ICMP报文头部（8字节）包含以下字段：

- 类型（Type）（1字节）：指定ICMP消息的类型。
- 代码（Code）（1字节）：提供与消息类型相关的更多详细信息。
- 校验和（Checksum）（2字节）：用于校验ICMP报文的完整性。
- 标识符（Identifier）（2字节）：通常用于标识与ICMP消息相关的进程或会话。
- 序列号（Sequence Number）（2字节）：用于标识具体的ICMP消息。

数据部分是可选的，其内容和长度根据具体的ICMP消息类型和代码而定。不同的ICMP消息类型有不同的数据结构和格式。





## ping 实战[查询报文类型]

仅使用网络层



我们常用的指令ping就是使用ICMP的原理。



例如，我当前的ip地址为10.10.10.10,现在ping www.baidu.com，此时会先通过DNS解析将www.baiduc.om解析为相应的地址，然后再封装对应的ICMP包进行发送，ICMP中type为echo request；当百度的机器收到我们的数据包后，发现这是一个type 为echo request的包，所以会回给我们主机一个对应的echo reply包。

现在我们来抓包试一下。

首先查看我们的主机的转发表，看看默认的网关在哪？

`route -n `

![image-20230921163835694](https://2290653824-github-io.oss-cn-hangzhou.aliyuncs.com/image-20230921163835694.png)

默认网关在这个地址`10.10.10.1`，同时其对应的网卡为 enpls0，所以我们需要再enpls0这个网卡上进行抓包。

输入抓包指令

`tcpdump -i enp1s0: -w capture.pcap`

![image-20230921164353098](https://2290653824-github-io.oss-cn-hangzhou.aliyuncs.com/image-20230921164353098.png)

开启另一个客户端：

`ping www.baidu.com`

![image-20230921164413210](https://2290653824-github-io.oss-cn-hangzhou.aliyuncs.com/image-20230921164413210.png)



将抓包的文件放到wireshark中进行分析，过滤条件为`icmp`

![image-20230921164937932](https://2290653824-github-io.oss-cn-hangzhou.aliyuncs.com/image-20230921164937932.png)

可以看到基本上都是成对的存在的。现在我们将 echo request 和  echo reply 打开看看内容

- echo request

![image-20230921165249809](https://2290653824-github-io.oss-cn-hangzhou.aliyuncs.com/image-20230921165249809.png)

- echo reply

![image-20230921165330573](https://2290653824-github-io.oss-cn-hangzhou.aliyuncs.com/image-20230921165330573.png)



从上面可以看出来，`ping` 的发送方用的`type = echo request` 进行发送，对应的注解收到对应的包后会回应 `type = reply request`



## tranceroute实战[差错报文协议]

原理

它的原理就是利用 IP 包的**生存期限** 从 `1` 开始按照顺序递增的同时发送 **UDP 包**，强制接收 **ICMP 超时消息**的一种方法。

比如，将 TTL 设置 为 `1`，则遇到第一个路由器，就牺牲了，接着返回 ICMP 差错报文网络包，类型是**时间超时**。

接下来将 TTL 设置为 `2`，第一个路由器过了，遇到第二个路由器也牺牲了，也同时返回了 ICMP 差错报文数据包，如此往复，直到到达目的主机。

这样的过程，traceroute 就可以拿到了所有的路由器 IP。

当然有的路由器根本就不会返回这个 ICMP，所以对于有的公网地址，是看不到中间经过的路由的。

> 发送方如何知道发出的 UDP 包是否到达了目的主机呢？

traceroute 在发送 `UDP` 包时，会填入一个**不可能的端口号**值作为 UDP 目标端口号：33434。然后对于每个下一个探针，它都会增加一个，这些端口都是通常认为不会被使用，不过，没有人知道当某些应用程序监听此类端口时会发生什么。

当目的主机，收到 UDP 包后，会返回 ICMP 差错报文消息，但这个差错报文消息的类型是「**端口不可达**」。

所以，**当差错报文类型是端口不可达时，说明发送方发出的 UDP 包到达了目的主机。**



思考：我们使用traceRoute命令，一般情况是traceRoute 111.112.212.112 这种形式，既然我们也没有指定其他参数什么的，那么为什么traceRoute不能像ping一样直接使用ICMP协议，而还需要外加一层UDP协议呢？



首先我们的ping的主要作用是关注一台主机是否可以直连，我们并不关系期间经历了什么，一条ping命令发送出去后，只需要关注传回的echo reply就可以了。但是traceRoute他的作用是不一样的，traceRoute还需要关注经过的每一台机器，怎么让每一台机器向主机发送回送信息是关键。考虑到ICMP中有差错报文，可以让在中间节点发生差错而返回ICMP报文，这个时候就可以涉及到传输层中的TTL了，当一个路由器上的报文TTL时长为0，则丢弃并返回ICMP type =11 超时报文，这样主机就可以拿到对应的路由信息。那么现在就需要思考我们使用tcp还是udp了。





惊讶的发现其实traceRoute有不同的实现。

https://zhuanlan.zhihu.com/p/101810847



http://129.226.226.195/post/33482.html




































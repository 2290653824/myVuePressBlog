

## k8s整体架构

  

kubectl 

dashboard





k8s master节点【控制面板】

Api-server

kube-Controller-manager 管理各个类型的控制器，针对k8s中的各种资源进行管理

cloud-controller-manager 云控制器管理器，第三方云平台提供的控制器api对接管理控制【第三方云平台】

kube-schedule：调度器 负责将pod基于一定的算法，将其调用到更合适的节点（服务器）上。举例：我现在有一个mysql的容器，而mysql需要存储能力比较强的机器，schedule就来决定这个mysql容器会分配到哪个服务器上。

etcd：k8s自己的数据库kv，分布式数据库。提供基于raft算法实现自主的集群高可用。【老版本：基于内存；新版本：持久化存储】

![image-20230825143910783](https://2290653824-github-io.oss-cn-hangzhou.aliyuncs.com/image-20230825143910783.png)



k8s node节点

kubelet 负责Pod的声明周期和存储管理、网络

kube-proxy 网络代理，负责server的服务发现和负载均衡（4层：网络层，iptables）

container-runtime 容器的运行时环境：docker、containerd、CRI-O【可以从多个当中选一个容器方案】

pod：运行了容器1、容器2、容器3。至少要有一个容器。【一台服务器是一个节点，一个节点下有多个pod，每一个pod下可以运行多个容器】

![image-20230825144701160](https://2290653824-github-io.oss-cn-hangzhou.aliyuncs.com/image-20230825144701160.png)

一个master、多个节点

apiServer、pod是核心



附加的一些组件

kube-dns 为整个集群提供DNS服务

Ingress Controller 让外部网络可以访问一个节点里的pod

heapster 资源监控（也可以用普罗米修斯）

dashboard

federation 跨集群

es 日志存储



k8s的分层架构

![image-20230825145112805](https://2290653824-github-io.oss-cn-hangzhou.aliyuncs.com/image-20230825145112805.png)





## 服务分类

![image-20230825145259165](https://2290653824-github-io.oss-cn-hangzhou.aliyuncs.com/image-20230825145259165.png)

有状态：对本地的存储系统会有依赖，如果要进行扩容，则还需要拷贝存储系统才行。



资源和对象

k8s里面一切都是自愿，在k8s里面自愿可以通过配置文件的方式进行定义配置【资源清单】。

对象：根据资源创建出来的对象

![image-20230825150448450](https://2290653824-github-io.oss-cn-hangzhou.aliyuncs.com/image-20230825150448450.png)

![image-20230825150458929](https://2290653824-github-io.oss-cn-hangzhou.aliyuncs.com/image-20230825150458929.png)



对象规约spec和状态status

![image-20230825150718509](https://2290653824-github-io.oss-cn-hangzhou.aliyuncs.com/image-20230825150718509.png)

状态status：表示对象的实际状态，k8s自己维护，k8s通过一系列控制器对对象进行管理，让对象接近期望状态spec





#### 资源的分类

元数据

>对于资源的元数据描述，每个资源都可以使用元空间的数据

Horizontal Pod Autoscalar (HPA)  【pod自动伸缩】

![image-20230825152518162](https://2290653824-github-io.oss-cn-hangzhou.aliyuncs.com/image-20230825152518162.png)

PodTemplate

![image-20230825152725395](https://2290653824-github-io.oss-cn-hangzhou.aliyuncs.com/image-20230825152725395.png)



LimitRange

![image-20230825152823920](https://2290653824-github-io.oss-cn-hangzhou.aliyuncs.com/image-20230825152823920.png)

如通过HPA进行自动伸缩时，根据podTemplate进行pod的创建，并通过limitrange来限制pod资源的使用







集群

> 集群资源的空间，作用于集群之上，集群下的所有的资源都是可以共享使用的。就例如一个进程，进程下的资源线程都可以享用

namespace

node

![image-20230825153117884](https://2290653824-github-io.oss-cn-hangzhou.aliyuncs.com/image-20230825153117884.png)

clusterRole 对集群权限进行管理

ClusterRolebing 绑定角色与资源进行绑定，都是集群集群上的权限管理





**命名空间**

> 一个集群下可以有多个命名空间，命名空间内的资源可以共享，不同命名空间之间的数据不能进行共享

- 工作负载型

**Pod**：

![image-20230825154810882](https://2290653824-github-io.oss-cn-hangzhou.aliyuncs.com/image-20230825154810882.png)

![image-20230825154829062](https://2290653824-github-io.oss-cn-hangzhou.aliyuncs.com/image-20230825154829062.png)



![image-20230825154922810](https://2290653824-github-io.oss-cn-hangzhou.aliyuncs.com/image-20230825154922810.png)



![image-20230825155101676](https://2290653824-github-io.oss-cn-hangzhou.aliyuncs.com/image-20230825155101676.png)



pod控制器

用来控制pod怎么来创建

无状态

ReplicationController RC【新版本已经废除】

可以帮助我们动态的去完成pod的扩容和缩容。根据用于定义的副本数量

缺点：需要rc与pod进行绑定，很麻烦

ReplicaSet（RS) 

![image-20230825160122969](https://2290653824-github-io.oss-cn-hangzhou.aliyuncs.com/image-20230825160122969.png)

可以通过selector来选择对哪些pod生效，即可以选择多个不通话的pod

![image-20230825160558480](https://2290653824-github-io.oss-cn-hangzhou.aliyuncs.com/image-20230825160558480.png)

label

selector

**Deployment**

RC和RS只有扩容和缩容，这是不够的。

对RS进行了再次的封装。提供了更多部署的特性。

> - 创建rs，pod
>
> 用户可以根据dm创建pod，dm会自动帮助我们创建rs
>
> - 平滑扩容和缩容
>
> ![image-20230825161601001](https://2290653824-github-io.oss-cn-hangzhou.aliyuncs.com/image-20230825161601001.png)
>
> 原来的rs控制的为APP2两个，当我们进行升级的服务时，dy会创建自动创建一个新的rs2，rs2复制一个app2并启动，同时关掉rs1的一个APP2，实现平滑更新
>
> - 暂停和恢复
> - 回滚





有状态

statefulSet

![image-20230825161908003](https://2290653824-github-io.oss-cn-hangzhou.aliyuncs.com/image-20230825161908003.png)

![image-20230825162406252](https://2290653824-github-io.oss-cn-hangzhou.aliyuncs.com/image-20230825162406252.png)

- headless Service 

DNS管理

- volumeClaimTemplate

用于持久化卷的模版





守护进程

DaemonSet

![image-20230825162724300](https://2290653824-github-io.oss-cn-hangzhou.aliyuncs.com/image-20230825162724300.png)

任务/定时

job

cronJob







> 在Kubernetes中，"元数据"、"集群"和"命名空间"是三个重要的概念，用于管理和组织集群中的资源。
>
> 1. **元数据（Metadata）**: 在Kubernetes中，元数据是关于各种资源（如Pods、Services、Deployments等）的描述性信息。这些信息包括资源的名称、标签、注释、创建时间、命名空间等。元数据帮助用户和系统理解资源的属性和上下文，有助于对资源进行管理、查询和监控。
> 2. **集群（Cluster）**: Kubernetes集群是由多个物理或虚拟计算机（节点）组成的集合，用于运行容器化应用程序。这些节点可以分布在不同的主机上，并且由Kubernetes进行管理和编排。集群包括控制平面（主节点）和工作节点。控制平面负责管理和控制集群中的资源，而工作节点负责运行实际的容器和应用程序。
> 3. **命名空间（Namespace）**: 命名空间是Kubernetes中用于对资源进行隔离和分组的机制。通过将资源放置在不同的命名空间中，可以将不同的团队、项目或应用程序隔离开来，以避免冲突和资源干扰。同一种类型的资源（如Pods、Services等）可以在不同的命名空间中具有相同的名称，而不会产生冲突。命名空间还有助于对资源进行权限控制和资源配额设置。
>
> 总之，元数据是描述性信息，集群是由节点组成的容器化应用程序环境，命名空间是用于隔离和组织资源的分组机制。这些概念共同帮助Kubernetes用户有效地管理和操作他们的应用程序和服务。

![image-20230825151710499](https://2290653824-github-io.oss-cn-hangzhou.aliyuncs.com/image-20230825151710499.png)









集群搭建：

![image-20230825163054340](https://2290653824-github-io.oss-cn-hangzhou.aliyuncs.com/image-20230825163054340.png)

此次搭建方案使用 kubeadm方式：

![image-20230825164134100](https://2290653824-github-io.oss-cn-hangzhou.aliyuncs.com/image-20230825164134100.png)





## K8S集群搭建



### 1. 初始操作

```shell
# 关闭防火墙
systemctl stop firewalld
systemctl disable firewalld

# 关闭selinux
set -i 's/enforcing/disable' /etc/selinux/config # 永久
setenforce 0 #临时

# 关闭swap
swapoff -a #临时
sed -ri 's/.*swap.*/#&/' /etc/fstab #永久

# 关闭完swap后，一定要重启下虚拟机

# 根据规划设置主机名
hostnamectl set-hostname <hostname>

# 在master添加hosts
cat >> /etc/hosts << EOF
192.168.113.120 k8s-master
192.168.113.121 k8s-node1
192.168.113.122 k8s-node2
EOF

# 将桥接的IPV4流量传递到iptables的链
cat > /etc/sysctl.d/k8s.conf << EOF
net.bridge.bridge-nf-call-ip6tables = 1
net.bridge.bridge-nf-call-iptables = 1
EOF

sysctl --system # 生效

# 时间同步
yum install ntpdate -y
ntpdate time.windows.com

```



### 2. 安装基础软件 基于ubuntu 20.04.1

#### 安装docker

```shell
```

[ubuntu 安装](https://zhuanlan.zhihu.com/p/143156163)

#### 添加阿里云yum源



#### 安装kubeadm、kubelet、kubectl

- `kubeadm`：用来初始化集群的指令。
- `kubelet`：在集群中的每个节点上用来启动 Pod 和容器等。
- `kubectl`：用来与集群通信的命令行工具。

```shell
snap install kubectl --classic
snap install kubelet --classic
snap install kubeadm --classic
```





#### 初始化集群

```shell
kubeadm init \
	--apiserver-advertise-address=122.228.207.18 \
	--image-repository registry.aliyuncs.com/google_containers \
	--kubernetes-version=v1.28.0 \
	--service-cidr=10.96.0.0/12 \
	--pod-network-cidr=10.244.0.0/16
```






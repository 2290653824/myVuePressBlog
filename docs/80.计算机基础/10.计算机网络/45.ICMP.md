---
title: ICMP
date: 2023-04-03 23:25:36
permalink: /pages/da7840/
categories:
  - 计算机基础
  - 计算机网络
tags:
  - 
author: 
  name: xugaoyi
  link: https://github.com/xugaoyi
---


## ICMP

Internet Control Message Protocol 网络控制报文协议

关键字：控制

在网络层当中，一条数据包发送出去过后，我怎么知道这个数据是否发送成功还是发送失败？发送失败错误原因是什么呢？就像我们前端调用后端接口，前端调用后总有个返回信息说明请求成功或者错误原因吧。







## 功能

确认IP包是否成功发送到目的地址、报告发送过程中IP包被抛弃的原因和改善网络的设置等。

> 在ip通信过程中，如果某个ip包因为某种原因没有成功到达目的地，那么这个失败的原因就由ICMP来负责通知给发送方。



![image-20230403233740085](https://2290653824-github-io.oss-cn-hangzhou.aliyuncs.com/undefinedimage-20230403233740085.png)

解析：

如上图例子，主机 `A` 向主机 `B` 发送了数据包，由于某种原因，途中的路由器 `2` 未能发现主机 `B` 的存在，这时，路由器 `2` 就会向主机 `A` 发送一个 `ICMP` 目标不可达数据包，说明发往主机 `B` 的包未能成功。

ICMP 的这种通知消息会使用 `IP` 进行发送 。

因此，从路由器 `2` 返回的 ICMP 包会按照往常的路由控制先经过路由器 `1` 再转发给主机 `A` 。收到该 ICMP 包的主机 `A` 则分解 ICMP 的首部和数据域以后得知具体发生问题的原因。





## ICMP 类型

- 一类是用于诊断的查询消息，也就是「**查询报文类型**」
- 另一类是通知出错原因的错误消息，也就是「**差错报文类型**」

![image-20230403233942152](https://2290653824-github-io.oss-cn-hangzhou.aliyuncs.com/undefinedimage-20230403233942152.png)

## 报文结构

```shell
+-----------------------------------------------------------------------+
|              ICMP报文头部（固定长度8字节）                             |
+-----------------------------------------------------------------------+
|                            数据数据...                               |
+-----------------------------------------------------------------------+
```

ICMP报文头部（8字节）包含以下字段：

- 类型（Type）（1字节）：指定ICMP消息的类型。
- 代码（Code）（1字节）：提供与消息类型相关的更多详细信息。
- 校验和（Checksum）（2字节）：用于校验ICMP报文的完整性。
- 标识符（Identifier）（2字节）：通常用于标识与ICMP消息相关的进程或会话。
- 序列号（Sequence Number）（2字节）：用于标识具体的ICMP消息。

数据部分是可选的，其内容和长度根据具体的ICMP消息类型和代码而定。不同的ICMP消息类型有不同的数据结构和格式。





## ping 实战

我们常用的指令ping就是使用ICMP的原理。



例如，我当前的ip地址为10.10.10.10,现在ping www.baidu.com，此时会先通过DNS解析将www.baiduc.om解析为相应的地址，然后再封装对应的ICMP包进行发送，ICMP中type为echo request；当百度的机器收到我们的数据包后，发现这是一个type 为echo request的包，所以会回给我们主机一个对应的echo reply包。

现在我们来抓包试一下。

首先查看我们的主机的转发表，看看默认的网关在哪？

`route -n `

![image-20230921163835694](https://2290653824-github-io.oss-cn-hangzhou.aliyuncs.com/image-20230921163835694.png)

默认网关在这个地址`10.10.10.1`，同时其对应的网卡为 enpls0，所以我们需要再enpls0这个网卡上进行抓包。

输入抓包指令

`tcpdump -i enp1s0: -w capture.pcap`

![image-20230921164353098](https://2290653824-github-io.oss-cn-hangzhou.aliyuncs.com/image-20230921164353098.png)

开启另一个客户端：

`ping www.baidu.com`

![image-20230921164413210](https://2290653824-github-io.oss-cn-hangzhou.aliyuncs.com/image-20230921164413210.png)



将抓包的文件放到wireshark中进行分析，过滤条件为`icmp`

![image-20230921164937932](https://2290653824-github-io.oss-cn-hangzhou.aliyuncs.com/image-20230921164937932.png)

可以看到基本上都是成对的存在的。现在我们将 echo request 和  echo reply 打开看看内容

- echo request

![image-20230921165249809](https://2290653824-github-io.oss-cn-hangzhou.aliyuncs.com/image-20230921165249809.png)

- echo reply

![image-20230921165330573](https://2290653824-github-io.oss-cn-hangzhou.aliyuncs.com/image-20230921165330573.png)



从上面可以看出来，`ping` 的发送方用的`type = echo request` 进行发送，对应的注解收到对应的包后会回应 `type = reply request`










































---
title: jvmè°ƒä¼˜
date: 2023-06-09 17:07:38
permalink: /pages/f070cc/
categories:
  - java
  - javaè¿›é˜¶
  - JVM
tags:
  - 
author: 
  name: xugaoyi
  link: https://github.com/xugaoyi
---


## JVMå¸¸è§å·¥å…·ä»‹ç»

### [#](https://www.sharkchili.com/pages/3361b8/#jinfo-æŸ¥çœ‹é…ç½®ä¿¡æ¯)jinfo(æŸ¥çœ‹é…ç½®ä¿¡æ¯)

æŸ¥çœ‹`Java`åº”ç”¨ç¨‹åºé…ç½®å‚æ•°æˆ–è€…`JVM`ç³»ç»Ÿå±æ€§ï¼Œç›¸å…³å‘½ä»¤è¯¦æƒ…æˆ‘ä»¬å¯ä»¥ä½¿ç”¨`-help`æˆ–è€…`man`å‘½ä»¤æŸ¥çœ‹ï¼Œå¦‚ä¸‹æ‰€ç¤º:

```go
[root@xxxxxtmp]# jinfo -help
Usage:
    jinfo [option] <pid>
        (to connect to running process)
    jinfo [option] <executable <core>
        (to connect to a core file)
    jinfo [option] [server_id@]<remote server IP or hostname>
        (to connect to remote debug server)

where <option> is one of:
    -flag <name>         to print the value of the named VM flag
    -flag [+|-]<name>    to enable or disable the named VM flag
    -flag <name>=<value> to set the named VM flag to the given value
    -flags               to print VM flags
    -sysprops            to print Java system properties
    <no option>          to print both of the above
    -h | -help           to print this help message
```

ä¸ºäº†æ¼”ç¤ºï¼Œç¬”è€…åœ¨æœåŠ¡å™¨ä¸Šå¼€å¯äº†ä¸€ä¸ªJavaåº”ç”¨ï¼Œæˆ‘ä»¬å¯ä»¥ä½¿ç”¨`jps`å‘½ä»¤æŸ¥çœ‹å…¶è¿›ç¨‹`id`,å¯ä»¥çœ‹åˆ°ç¬”è€…æœåŠ¡å™¨ä¸­æœ‰ä¸€ä¸ª`pid`ä¸º`19946`çš„Javaè¿›ç¨‹ã€‚

```text
[root@iZ8vb7bhe4b8nhhhpavhwpZ tmp]# jps
20104 Jps
19946 jar
```

æŸ¥çœ‹å½“å‰åº”ç”¨æ‰€æœ‰çš„é…ç½®å‚æ•°ä»¥åŠç³»ç»Ÿé…ç½®å±æ€§å‘½ä»¤ä¸º`jinfo pid`å¦‚ä¸‹æ‰€ç¤º:

```text
[root@xxxxx tmp]# jinfo 19946
Attaching to process ID 19946, please wait...
Debugger attached successfully.
Server compiler detected.
JVM version is 25.202-b08
Java System Properties:

java.runtime.name = Java(TM) SE Runtime Environment
java.vm.version = 25.202-b08
sun.boot.library.path = /root/jdk8/jre/lib/amd64
java.protocol.handler.pkgs = org.springframework.boot.loader
java.vendor.url = http://java.oracle.com/
java.vm.vendor = Oracle Corporation
path.separator = :
file.encoding.pkg = sun.io
java.vm.name = Java HotSpot(TM) 64-Bit Server VM
sun.os.patch.level = unknown
sun.java.launcher = SUN_STANDARD
user.country = US
user.dir = /tmp


......
```

å¦‚æœæˆ‘ä»¬å¸Œæœ›æŸ¥çœ‹å½“å‰Javaåº”ç”¨æ˜¯å¦æœ‰é…ç½®æŸäº›ä¿¡æ¯ï¼Œå¯ä»¥ä½¿ç”¨å‘½ä»¤`jinfo -flag é…ç½®é€‰é¡¹ pid`ï¼Œä¾‹å¦‚æˆ‘ä»¬æƒ³æŸ¥çœ‹å½“å‰åº”ç”¨æ˜¯å¦æœ‰å¼€å¯`gcé€‰é¡¹`ï¼Œå¯ä»¥ä½¿ç”¨ä¸‹é¢è¿™æ®µå‘½ä»¤

å¯ä»¥çœ‹åˆ°è¾“å‡ºç»“æœä¸º`-XX:-PrintGC`ï¼Œå› ä¸º`PrintGC`å‰é¢æ˜¯å‡å·ï¼Œè¿™è¯´æ˜è¯¥é€‰é¡¹å¹¶æ²¡æœ‰å¼€å¯ã€‚

```go
[root@xxx tmp]# jinfo -flag PrintGC 19946
-XX:-PrintGC
```

å¦‚æœæˆ‘ä»¬å¸Œæœ›å°†è¿™ä¸ªé€‰é¡¹å¼€å¯ï¼Œæˆ‘ä»¬åªéœ€åœ¨å‚æ•°å‰é¢åŠ ä¸ª+å·å³å¯ï¼Œä¾‹å¦‚æˆ‘ä»¬å¸Œæœ›å¼€å¯`gcé€‰é¡¹`ï¼Œæˆ‘ä»¬åªéœ€é”®å…¥å¦‚ä¸‹å‘½ä»¤

```go
[root@xxxxxtmp]# jinfo -flag +PrintGC 19946
```

å†æ¬¡æŸ¥çœ‹å¯ä»¥å‘ç°ï¼Œé€‰é¡¹ç”Ÿæ•ˆäº†

```go
[root@xxxx tmp]# jinfo -flag PrintGC 19946
-XX:+PrintGC
```

æœ‰äº›å‚æ•°æ˜¯é”®å€¼å¯¹çš„å½¢å¼ï¼Œä¾‹å¦‚æˆ‘ä»¬æƒ³é…ç½®dumpæ—¥å¿—çš„è·¯å¾„ï¼Œæˆ‘ä»¬ä¹Ÿå¯ä»¥ä½¿ç”¨jinfoè¿›è¡Œé…ç½®ï¼Œå‘½ä»¤æ ¼å¼ä¸º`jinfo -flag å‚æ•°=å€¼ Javaè¿›ç¨‹id`

```text
jinfo -flag HeapDumpPath=/tmp/dump.log 19946
```

æ‰“å°JVMé€‰é¡¹ä¿¡æ¯

```text
jinfo -flags 4854
Attaching to process ID 4854, please wait...
Debugger attached successfully.
Server compiler detected.
JVM version is 25.202-b08
Non-default VM flags: -XX:CICompilerCount=2 -XX:HeapDumpPath=null -XX:InitialHeapSize=33554432 -XX:MaxHeapSize=511705088 -XX:MaxNewSize=170524672 -XX:MinHeapDeltaBytes=196608 -XX:NewSize=11141120 -XX:OldSize=22413312 -XX:+PrintGC -XX:+UseCompressedClassPointers -XX:+UseCompressedOops -XX:+UseFastUnorderedTimeStamps
Command line:
```

æŸ¥çœ‹åº”ç”¨å±æ€§ï¼Œå‘½ä»¤æ ¼å¼`jinfo -sysprops Javaè¿›ç¨‹id`

```text
jinfo -sysprops 2341
```

### [#](https://www.sharkchili.com/pages/3361b8/#jmap-æŸ¥çœ‹å †åŒºä¿¡æ¯ã€å¯¹è±¡ä¿¡æ¯ç­‰)jmap(æŸ¥çœ‹å †åŒºä¿¡æ¯ã€å¯¹è±¡ä¿¡æ¯ç­‰)

`jmap`ä½œç”¨:

1. æŸ¥çœ‹ä½¿ç”¨çš„GCç®—æ³•ï¼Œå †çš„é…ç½®ä¿¡æ¯ä»¥åŠå„ä¸ªå†…å­˜åŒºåŸŸçš„å†…å­˜ä½¿ç”¨æƒ…å†µ
2. æ˜¾ç¤ºå †å¯¹è±¡çš„ç»Ÿè®¡ä¿¡æ¯ï¼ŒåŒ…æ‹¬æ¯ä¸€ä¸ª`Java`ç±»ã€å¯¹è±¡æ•°é‡ã€å†…å­˜å¤§å°ã€ç±»åç§°ç­‰
3. æ‰“å°ç­‰ä¼šå›æ”¶çš„å¯¹è±¡çš„ä¿¡æ¯
4. ç”Ÿæˆ`dump`æ–‡ä»¶ï¼Œé…åˆ`jhat`ä½¿ç”¨

æŸ¥çœ‹å †å†…å­˜ä½¿ç”¨æƒ…å†µ `jmap -heap Javaè¿›ç¨‹id`

```text
[root@iZ8vb7bhe4b8nhhhpavhwpZ tmp]# jmap -heap 25534
Attaching to process ID 25534, please wait...
Debugger attached successfully.
Server compiler detected.
JVM version is 25.202-b08

using thread-local object allocation.
Mark Sweep Compact GC

Heap Configuration:
   MinHeapFreeRatio         = 40
   MaxHeapFreeRatio         = 70
   MaxHeapSize              = 511705088 (488.0MB)
   NewSize                  = 11141120 (10.625MB)
   MaxNewSize               = 170524672 (162.625MB)
   OldSize                  = 22413312 (21.375MB)
   NewRatio                 = 2
   SurvivorRatio            = 8
   MetaspaceSize            = 21807104 (20.796875MB)
   CompressedClassSpaceSize = 1073741824 (1024.0MB)
   MaxMetaspaceSize         = 17592186044415 MB
   G1HeapRegionSize         = 0 (0.0MB)
```

æŸ¥çœ‹å­˜æ´»çš„`Java`å¯¹è±¡ï¼Œå‘½ä»¤æ ¼å¼: `jmap -histo:live Javaè¿›ç¨‹id`

```text
[root@xxxtmp]# jmap -histo:live 25534

 num     #instances         #bytes  class name
----------------------------------------------
   1:         48676        7974952  [C
   2:          7762        1873312  [I
   3:         47785        1146840  java.lang.String
   4:         12737        1120856  java.lang.reflect.Method
   5:          8773         968912  java.lang.Class
   6:         25572         818304  java.util.concurrent.ConcurrentHashMap$Node
   7:         14108         564320  java.util.LinkedHashMap$Entry
   8:          2712         509536  [B
   9:          9308         494936  [Ljava.lang.Object;
  10:          6345         493128  [Ljava.util.HashMap$Node;
  11:          7001         392056  java.util.LinkedHashMap
  12:         11255         360160  java.util.HashMap$Node
  13:         15946         354528  [Ljava.lang.Class;
  14:         18176         290816  java.lang.Object
  15:          3447         248184  java.lang.reflect.Field
  16:           124         192320  [Ljava.util.concurrent.ConcurrentHashMap$Node;
```

æ‰“å°æ­£åœ¨è¢«å›æ”¶çš„ç±»,å‘½ä»¤æ ¼å¼:`jmap -finalizerinfo Javaè¿›ç¨‹id`

```text
[root@xxxtmp]# jmap -finalizerinfo 25534
Attaching to process ID 25534, please wait...
Debugger attached successfully.
Server compiler detected.
JVM version is 25.202-b08
Number of objects pending for finalization: 0
```

å°†å­˜æ´»çš„å¯¹è±¡çš„ä¿¡æ¯å­˜åˆ°äºŒè¿›åˆ¶æ–‡ä»¶ä¸­

```text
 jmap -dump:live,format=b,file=/tmp/heap.bin 25534
Dumping heap to /tmp/heap.bin ...
Heap dump file created
```

æ­¤æ—¶å°±å¯ä»¥ä½¿ç”¨`jhat`æ‰“å¼€è¯¥æ–‡ä»¶,å¦‚ä¸‹æ‰€ç¤º`jhat æ–‡ä»¶å`,è¿™æ—¶å€™æˆ‘ä»¬å°±å¯ä»¥é€šè¿‡`7000`ç«¯å£æŸ¥çœ‹è¯¦æƒ…äº†ã€‚

```text
[root@xxxtmp]# jhat heap.bin
Reading from heap.bin...
Dump file created Wed Nov 02 20:21:18 CST 2022
Snapshot read, resolving...
Resolving 346825 objects...
Chasing references, expect 69 dots.....................................................................
Eliminating duplicate references.....................................................................
Snapshot resolved.
Started HTTP server on port 7000
Server is ready.
```

### [#](https://www.sharkchili.com/pages/3361b8/#jstat-å¸¸ç”¨-ç›‘æ§è¿è¡Œæ—¶çŠ¶æ€ä¿¡æ¯)jstat(å¸¸ç”¨ï¼Œç›‘æ§è¿è¡Œæ—¶çŠ¶æ€ä¿¡æ¯)

jstatç”¨äºç›‘æ§è™šæ‹Ÿæœºå„ç§è¿è¡ŒçŠ¶æ€ä¿¡æ¯ï¼Œæ˜¾ç¤ºè™šæ‹Ÿæœºè¿›ç¨‹ä¸­è£…åœ¨ã€å†…å­˜ã€åƒåœ¾æ”¶é›†ã€JITç¼–è¯‘ç­‰è¿è¡Œæ•°æ®ã€‚

æŸ¥çœ‹ç±»åŠ è½½ä¿¡æ¯ï¼Œå‘½ä»¤æ ¼å¼`jstat -class Javaè¿›ç¨‹id`

```text
[root@iZ8vb7bhe4b8nhhhpavhwpZ tmp]# jstat -class 2341
Loaded  Bytes  Unloaded  Bytes     Time
  8221 14604.3        1     0.9      12.74
[root@iZ8vb7bhe4b8nhhhpavhwpZ tmp]#
```

æŸ¥çœ‹ç¼–è¯‘ç»Ÿè®¡ä¿¡æ¯`jstat -compiler Javaè¿›ç¨‹id`

```text
[root@xxxtmp]# jstat -compiler 2341
Compiled Failed Invalid   Time   FailedType FailedMethod
    4177      0       0    17.68          0
[root@iZ8vb7bhe4b8nhhhpavhwpZ tmp]#
```

æŸ¥çœ‹`gc`ç»Ÿè®¡ä¿¡æ¯

```text
[root@iZ8vb7bhe4b8nhhhpavhwpZ tmp]# jstat -gc 2341
 S0C    S1C    S0U    S1U      EC       EU        OC         OU       MC     MU    CCSC   CCSU   YGC     YGCT    FGC    FGCT     GCT
1408.0 1408.0  0.0   1020.3 11840.0   7493.1   29268.0    22168.5   42840.0 40613.5 5760.0 5311.9     65    0.401   2      0.213    0.613
[root@iZ8vb7bhe4b8nhhhpavhwpZ tmp]#
```

æ¯ä¸ªè¡¨å¤´çš„å«ä¹‰å¦‚ä¸‹

```text
1. S0C :å¹´è½»ä»£ä¸­ç¬¬ä¸€ä¸ªsurvivorï¼ˆå¹¸å­˜åŒºï¼‰çš„å®¹é‡ (å­—èŠ‚)
2. S1C :å¹´è½»ä»£ä¸­ç¬¬äºŒä¸ªsurvivorï¼ˆå¹¸å­˜åŒºï¼‰çš„å®¹é‡ (å­—èŠ‚)
3. S0U:å¹´è½»ä»£ä¸­ç¬¬ä¸€ä¸ªsurvivorï¼ˆå¹¸å­˜åŒºï¼‰ç›®å‰å·²ä½¿ç”¨ç©ºé—´ (å­—èŠ‚)
4. S1U:å¹´è½»ä»£ä¸­ç¬¬äºŒä¸ªsurvivorï¼ˆå¹¸å­˜åŒºï¼‰ç›®å‰å·²ä½¿ç”¨ç©ºé—´ (å­—èŠ‚)
5. EC:å¹´è½»ä»£ä¸­Edenï¼ˆä¼Šç”¸å›­ï¼‰çš„å®¹é‡ (å­—èŠ‚)
6. EU:å¹´è½»ä»£ä¸­Edenï¼ˆä¼Šç”¸å›­ï¼‰ç›®å‰å·²ä½¿ç”¨ç©ºé—´ (å­—èŠ‚)
7. OC:Oldä»£çš„å®¹é‡ (å­—èŠ‚)
8. OU:Oldä»£ç›®å‰å·²ä½¿ç”¨ç©ºé—´ (å­—èŠ‚)
9. PC:Perm(æŒä¹…ä»£)çš„å®¹é‡ (å­—èŠ‚)
10. PU:Perm(æŒä¹…ä»£)ç›®å‰å·²ä½¿ç”¨ç©ºé—´ (å­—èŠ‚)
11. YGC:ä»åº”ç”¨ç¨‹åºå¯åŠ¨åˆ°é‡‡æ ·æ—¶å¹´è½»ä»£ä¸­gcæ¬¡æ•°
12. YGCT:ä»åº”ç”¨ç¨‹åºå¯åŠ¨åˆ°é‡‡æ ·æ—¶å¹´è½»ä»£ä¸­gcæ‰€ç”¨æ—¶é—´(s)
13. FGC:ä»åº”ç”¨ç¨‹åºå¯åŠ¨åˆ°é‡‡æ ·æ—¶oldä»£(å…¨gc)gcæ¬¡æ•°
14. FGCT:ä»åº”ç”¨ç¨‹åºå¯åŠ¨åˆ°é‡‡æ ·æ—¶oldä»£(å…¨gc)gcæ‰€ç”¨æ—¶é—´(s)
15. GCT:ä»åº”ç”¨ç¨‹åºå¯åŠ¨åˆ°é‡‡æ ·æ—¶gcç”¨çš„æ€»æ—¶é—´(s)
```

æŸ¥çœ‹gcå†…å­˜å®¹é‡å’Œå…ƒç©ºé—´å®¹é‡

```text
[root@xxxtmp]# jstat -gccapacity 2341
 NGCMN    NGCMX     NGC     S0C   S1C       EC      OGCMN      OGCMX       OGC         OC       MCMN     MCMX      MC     CCSMN    CCSMX     CCSC    YGC    FGC
 10880.0 166528.0  14656.0 1408.0 1408.0  11840.0    21888.0   333184.0    29268.0    29268.0      0.0 1087488.0  42840.0      0.0 1048576.0   5760.0     65     2
```

æŸ¥çœ‹å¹´è½»ä»£ç»Ÿè®¡ä¿¡æ¯

```text
[root@xxxxtmp]# jstat -gcnew 2341
 S0C    S1C    S0U    S1U   TT MTT  DSS      EC       EU     YGC     YGCT
1408.0 1408.0    0.0 1020.3  2  15  704.0  11840.0   7652.5     65    0.401
[root@iZ8vb7bhe4b8nhhhpavhwpZ tmp]#
```

å‚æ•°è¯¦æƒ…

```text
1. S0C:å¹´è½»ä»£ä¸­ç¬¬ä¸€ä¸ªsurvivorï¼ˆå¹¸å­˜åŒºï¼‰çš„å®¹é‡ (å­—èŠ‚)
2. S1C:å¹´è½»ä»£ä¸­ç¬¬äºŒä¸ªsurvivorï¼ˆå¹¸å­˜åŒºï¼‰çš„å®¹é‡ (å­—èŠ‚)
3. S0U:å¹´è½»ä»£ä¸­ç¬¬ä¸€ä¸ªsurvivorï¼ˆå¹¸å­˜åŒºï¼‰ç›®å‰å·²ä½¿ç”¨ç©ºé—´ (å­—èŠ‚)
4. S1U:å¹´è½»ä»£ä¸­ç¬¬äºŒä¸ªsurvivorï¼ˆå¹¸å­˜åŒºï¼‰ç›®å‰å·²ä½¿ç”¨ç©ºé—´ (å­—èŠ‚)
5. TT:æŒæœ‰æ¬¡æ•°é™åˆ¶
6. MTT:æœ€å¤§æŒæœ‰æ¬¡æ•°é™åˆ¶
7. EC:å¹´è½»ä»£ä¸­Edenï¼ˆä¼Šç”¸å›­ï¼‰çš„å®¹é‡ (å­—èŠ‚)
8. EU:å¹´è½»ä»£ä¸­Edenï¼ˆä¼Šç”¸å›­ï¼‰ç›®å‰å·²ä½¿ç”¨ç©ºé—´ (å­—èŠ‚)
9. YGC:ä»åº”ç”¨ç¨‹åºå¯åŠ¨åˆ°é‡‡æ ·æ—¶å¹´è½»ä»£ä¸­gcæ¬¡æ•°
10. YGCT:ä»åº”ç”¨ç¨‹åºå¯åŠ¨åˆ°é‡‡æ ·æ—¶å¹´è½»ä»£ä¸­gcæ‰€ç”¨æ—¶é—´(s)
```

## [#](https://www.sharkchili.com/pages/3361b8/#äº†è§£jvm-gcæ—¥å¿—)äº†è§£JVM GCæ—¥å¿—

### [#](https://www.sharkchili.com/pages/3361b8/#è·å–æ—¥å¿—çš„ä¸¤ç§æ–¹å¼)è·å–æ—¥å¿—çš„ä¸¤ç§æ–¹å¼

è·å–GCæ—¥å¿—æ–¹å¼å¤§æŠµæœ‰ä»¥ä¸‹ä¸¤ç§:

1. è®¾å®šJVMå‚æ•°,å…·ä½“çš„å‘½ä»¤å‚æ•°ä¸º:

```text
-XX:+PrintGCDetails # æ‰“å°GCæ—¥å¿—
-XX:+PrintGCTimeStamps # æ‰“å°æ¯ä¸€æ¬¡è§¦å‘GCæ—¶å‘ç”Ÿçš„æ—¶é—´
```

1. åœ¨æœåŠ¡å™¨ä¸Šç›‘æ§:ä½¿ç”¨`jstat`æŸ¥çœ‹,å¦‚ä¸‹æ‰€ç¤ºï¼Œå‘½ä»¤æ ¼å¼ä¸º`jstat -gc pid è¾“å‡ºé—´éš”æ—¶é•¿ è¾“å‡ºæ¬¡æ•°`

```go
[root@xxxxx tmp]# jstat -gc 21608 1000 5
 S0C    S1C    S0U    S1U      EC       EU        OC         OU       MC     MU    CCSC   CCSU   YGC     YGCT    FGC    FGCT     GCT
1088.0 1088.0  0.0   666.5   8832.0   3102.0   21888.0    11286.8   32512.0 30346.5 4352.0 3842.7     31    0.161   1      0.035    0.195
1088.0 1088.0  0.0   666.5   8832.0   3102.0   21888.0    11286.8   32512.0 30346.5 4352.0 3842.7     31    0.161   1      0.035    0.195
1088.0 1088.0  0.0   666.5   8832.0   3102.0   21888.0    11286.8   32512.0 30346.5 4352.0 3842.7     31    0.161   1      0.035    0.195
1088.0 1088.0  0.0   666.5   8832.0   3102.0   21888.0    11286.8   32512.0 30346.5 4352.0 3842.7     31    0.161   1      0.035    0.195
1088.0 1088.0  0.0   666.5   8832.0   3102.0   21888.0    11286.8   32512.0 30346.5 4352.0 3842.7     31    0.161   1      0.035    0.195
```

### [#](https://www.sharkchili.com/pages/3361b8/#å¸¸è§é…ç½®å‚æ•°è§£æ)å¸¸è§é…ç½®å‚æ•°è§£æ

å¯¹åº”çš„JVMå‚æ•°å’Œå«ä¹‰ç¬”è€…éƒ½æ³¨é‡Šè§£é‡Šäº†ï¼Œè¯»è€…å¯è‡ªè¡Œé˜…è¯»

```text
-XX:NewSize=5M # å¹´è½»ä»£ç©ºé—´å¤§å°
-XX:MaxNewSize=5M # å¹´è½»ä»£æœ€å¤§ç©ºé—´å¤§å°
-XX:InitialHeapSize=10M # åˆå§‹åŒ–å †ç©ºé—´å¤§å°
-XX:MaxHeapSize=10M # æœ€å¤§å †å†…å­˜
-XX:SurvivorRatio=8 # edenå æ¯”ï¼Œä¾‹å¦‚è¿™é‡Œè®¾ç½®ä¸º8ï¼Œé‚£ä¹ˆedenå’ŒS0ã€S1åŒºæ€»ä½“æ¯”ä¾‹ä¸º8:1:1
-XX:PretenureSizeThreshold=10M # å¤§äºè¿™ä¸ªå€¼çš„å‚æ•°ç›´æ¥åœ¨è€å¹´ä»£åˆ†é…ã€‚è¿™æ ·åšçš„ç›®çš„æ˜¯é¿å…åœ¨EdenåŒºå’Œä¸¤ä¸ªSurvivoråŒºä¹‹é—´å‘ç”Ÿå¤§é‡çš„å†…å­˜å¤åˆ¶
-XX:+UseParNewGC # å¹´è½»ä»£ä½¿ç”¨çš„GCç®—æ³•
-XX:+UseConcMarkSweepGC # å¹¶è¡Œå¹¶å‘CMSåƒåœ¾å›æ”¶å™¨
-XX:+PrintGCDetails  # æ‰“å°GCæ—¥å¿—è¯¦æƒ…
-XX:+PrintGCTimeStamps # æ‰“å°æ¯æ¬¡è§¦å‘GCçš„æ—¶é—´
```

ç”±ä¸Šé¢çš„å‘½ä»¤æˆ‘å¯ä»¥çŸ¥é“å †åŒºåˆå§‹åŒ–å†…å­˜å’Œæœ€å¤§å†…å­˜ä¸º`10M`ï¼Œæ‰€ä»¥æˆ‘ä»¬å †åŒºçš„æ€»ç©ºé—´ä¸º`10M`ã€‚ è€Œå¹´è½»ä»£çš„å†…å­˜ä¸º`5M`ï¼Œå¹´è½»ä»£åŒ…å«`EdenåŒº`å’Œ`SurvivoråŒº`ï¼Œç”±å‚æ•°`XX:SurvivorRatio`å¯çŸ¥`Eden`åŒºå `8/10`ï¼Œæ‰€ä»¥`Eden`åŒºä¸º`4M`ï¼Œ`SurvivoråŒº`æ€»å¤§å°ä¸º`1M`ï¼Œç”±äº`Survivor`æœ‰ä¸¤ä¸ªæ‰€ä»¥æ¯ä¸ª`SurvivoråŒº`ä¸º`0.5M`ã€‚

![åœ¨è¿™é‡Œæ’å…¥å›¾ç‰‡æè¿°](https://qiniuyun.sharkchili.com/img202304071111068.png)

### [#](https://www.sharkchili.com/pages/3361b8/#å®è·µ-åŸºäºideaè°ƒè¯•åº”ç”¨ç¨‹åºäº†è§£å †jvmæ—¥å¿—)(å®è·µ)åŸºäºIDEAè°ƒè¯•åº”ç”¨ç¨‹åºäº†è§£å †JVMæ—¥å¿—

ä¸ºäº†æ¼”ç¤ºå¦‚ä½•æŸ¥çœ‹`GC`æ—¥å¿—ï¼Œæˆ‘ä»¬ä¸å¦¨å†™ä¸‹è¿™æ ·ä¸€æ®µä»£ç ï¼Œæˆ‘ä»¬åœ¨è®¡åˆ’å°†JVMå¹´è½»ä»£è®¾ç½®ä¸º5Mï¼Œé¦–å…ˆåˆ›å»º3Mçš„åƒåœ¾ï¼Œç„¶ååˆ›å»º2Mçš„å¯¹è±¡ï¼Œè§¦å‘`minor GC`ã€‚

ç¼–ç å¦‚ä¸‹æ‰€ç¤º:

```text
public class gcTest {
    public static void main(String[] args) {
        //åˆ¶é€ 3Mçš„åƒåœ¾
        byte[] bytes = new byte[1024 * 1024];
        bytes = new byte[1024 * 1024];
        bytes = new byte[1024 * 1024];

        //åˆ›å»º2Mçš„æ–°å¯¹è±¡è§¦å‘GC
        byte[] byte2 = new byte[2 * 1024 * 1024];
    }
}
```

ç„¶åæˆ‘åœ¨`IDEA`ä¸­çš„`JVM option`é…æ—¥å¿—ä¸‹é¢è¿™æ¡å‘½ä»¤ï¼Œæ¯ä¸€ä¸ªå‚æ•°çš„å‘½ä»¤ä¸Šé¢éƒ½ç»™å‡ºäº†ï¼Œä¸è®°å¾—çš„è¯»è€…å¯ä»¥ç¿»åˆ°ä¸Šæ–‡ä¸­æŸ¥é˜…ã€‚

```text
-XX:NewSize=5M -XX:MaxNewSize=5M -XX:InitialHeapSize=10M -XX:MaxHeapSize=10M -XX:SurvivorRatio=8 -XX:PretenureSizeThreshold=10M -XX:+UseParNewGC -XX:+UseConcMarkSweepGC -XX:+PrintGCDetails -XX:+PrintGCTimeStamps
```

![åœ¨è¿™é‡Œæ’å…¥å›¾ç‰‡æè¿°](https://qiniuyun.sharkchili.com/img202304071111331.png)

å®Œæˆåè¿è¡Œä»£ç ï¼Œå¯ä»¥åœ¨æ§åˆ¶å°è¾“å‡ºä¸‹é¢è¿™æ ·ä¸€æ®µå†…å®¹ï¼Œæˆ‘ä»¬ä¸å¦¨é€è¡Œè§£é‡Šä¸€ä¸‹è¯¦æƒ…

![åœ¨è¿™é‡Œæ’å…¥å›¾ç‰‡æè¿°](https://qiniuyun.sharkchili.com/img202304071111185.png)

é¦–å…ˆæ˜¯ç¬¬ä¸€è¡Œï¼Œæ„ä¸º`0.059s`è§¦å‘`å¹´è½»ä»£gc`ï¼Œå¹´è½»ä»£ä½¿ç”¨ç©ºé—´ä»`3655K`å˜ä¸º`512K`,è€Œå¹´è½»ä»£çš„æ€»ç©ºé—´ä¸º`4608K(eden+æœ‰å¯¹è±¡çš„såŒº)`ã€‚

åé¢`3655K->1671K(9728K)`åˆ™æ˜¯å †åŒºæ€»ç©ºé—´å¤§å°`9728K`ï¼Œä½¿ç”¨ç©ºé—´ç”±`3655K`å˜ä¸º`1671K`ã€‚

åç»­`Times`æŒ‰é¡ºåºå³ç”¨æˆ·ã€ç³»ç»Ÿã€æ—¶æœºè€—æ—¶æ—¶é—´ã€‚

```go
0.059: [GC (Allocation Failure) 0.059: [ParNew: 3655K->512K(4608K), 0.0008750 secs] 3655K->1671K(9728K), 0.0009085 secs] [Times: user=0.00 sys=0.00, real=0.00 secs] 
```

æ¥ä¸‹æ¥è¿™æ®µåˆ™æ˜¯å¹´è½»ä»£å †åŒºä¿¡æ¯ä½¿ç”¨æƒ…å†µï¼Œå¯ä»¥çœ‹åˆ°edenå¤§å°ä¸º4096Kï¼Œä½¿ç”¨äº†78%ã€‚fromå’Œto`(å³såŒº)`åŒç†ã€‚

```go
Heap
 par new generation   total 4608K, used 3746K [0x00000000ff600000, 0x00000000ffb00000, 0x00000000ffb00000)
  eden space 4096K,  78% used [0x00000000ff600000, 0x00000000ff9289d0, 0x00000000ffa00000)
  from space 512K, 100% used [0x00000000ffa80000, 0x00000000ffb00000, 0x00000000ffb00000)
  to   space 512K,   0% used [0x00000000ffa00000, 0x00000000ffa00000, 0x00000000ffa80000)
```

è¿™ä¸€æ®µä»¥ä¸ºè€å¹´ä»£ä½¿ç”¨æƒ…å†µ

```go
 concurrent mark-sweep generation total 5120K, used 1159K [0x00000000ffb00000, 0x0000000100000000, 0x0000000100000000)
```

æœ€åä¸¤æ®µä¸ºå…ƒæ•°æ®å’Œclassç©ºé—´ä½¿ç”¨æƒ…å†µï¼Œä¸å¸¸ç”¨åˆ°ï¼Œå°±ä¸å¤šåšè§£é‡Šäº†ã€‚

```go
 Metaspace       used 3159K, capacity 4496K, committed 4864K, reserved 1056768K
  class space    used 343K, capacity 388K, committed 512K, reserved 1048576K
```

## [#](https://www.sharkchili.com/pages/3361b8/#äº†è§£jvmå‡ ç§gcçš„åŒºåˆ«)äº†è§£JVMå‡ ç§GCçš„åŒºåˆ«

1. `Minor GC:`å‘ç”Ÿåœ¨å¹´è½»ä»£çš„ç©ºé—´å›æ”¶ï¼ŒåŒ…å«`eden`å’Œ`survivor`ï¼Œä¹Ÿå«åš`Young GC`ã€‚
2. `Major GC:`åœ¨è€å¹´ä»£å †åŒºè¿›è¡Œç©ºé—´å›æ”¶ã€‚
3. `Full GC:`æ¸…ç†æ‰€æœ‰å †åŒºçš„å†…å­˜ç©ºé—´çš„åƒåœ¾å†…å­˜ï¼ŒåŒ…æ‹¬å¹´è½»ä»£å’Œè€å¹´ä»£ã€‚

## [#](https://www.sharkchili.com/pages/3361b8/#å®è·µ-ä¿®å¤é¢‘ç¹çš„-minor-gc-å’Œ-major-gc)(å®è·µ)ä¿®å¤é¢‘ç¹çš„ Minor GC å’Œ Major GC

### [#](https://www.sharkchili.com/pages/3361b8/#äº†è§£é¢‘ç¹minor-gcçš„å±å®³å’ŒåŸå› )äº†è§£é¢‘ç¹Minor GCçš„å±å®³å’ŒåŸå› 

é€ æˆ`Minor GC`çš„åŸå› è¯´ç™½äº†å°±æ˜¯å¹´è½»ä»£ç©ºé—´å¤ªå°‘ï¼Œå½“æˆ‘ä»¬çš„åº”ç”¨ç¨‹åºéœ€è¦é¢‘ç¹çš„åˆ›å»ºå¯¹è±¡æ—¶ï¼Œå°±ä¼šè§¦å‘`Minor GC`ã€‚ é¢‘ç¹çš„`Minor GC`ä¼šå¯¼è‡´æœåŠ¡å“åº”æ—¶é—´å˜é•¿ï¼Œè€ŒåŸå› ä¹Ÿå¾ˆå¥½ç†è§£ï¼Œç”±ä¸Šçš„ä»‹ç»æˆ‘ä»¬çŸ¥é“é¢‘ç¹çš„`Minor GC`ä¼šå¯¼è‡´å¤§é‡çš„å¹´è½»ä»£åƒåœ¾è¢«å›æ”¶ï¼Œå¹¶ä¸”ä¼šå°†å­˜æ´»çš„å¯¹è±¡æ‹·è´çš„è€å¹´ä»£ï¼Œè€Œæ‹·è´è¿™ä¸ªè¡Œä¸ºæ˜¯éå¸¸æ¶ˆè€—ç³»ç»Ÿæ€§èƒ½çš„ã€‚

### [#](https://www.sharkchili.com/pages/3361b8/#å¤ç°é—®é¢˜)å¤ç°é—®é¢˜

æˆ‘ä»¬çš„ç¨‹åºç¼–å†™å¦‚ä¸‹æ‰€ç¤ºï¼Œåœ¨ä¸€ä¸ªforå¾ªç¯é‡Œé¢ï¼Œåˆ›å»º`3M`çš„åƒåœ¾åï¼Œå†åˆ›å»º`2M`çš„æ•°ç»„è§¦å‘`GC`

```text
public class gcTest {
    public static void main(String[] args) throws Exception {
        while (true) {
            //åˆ¶é€ 3Mçš„åƒåœ¾
            byte[] bytes = new byte[1024 * 1024];
            bytes = new byte[1024 * 1024];
            bytes = new byte[1024 * 1024];

            //åˆ›å»º2Mçš„æ–°å¯¹è±¡è§¦å‘GC
            byte[] byte2 = new byte[2 * 1024 * 1024];

            Thread.sleep(1000);
        }


    }
}
```

ä¸ºäº†æ¼”ç¤ºå¹´è½»ä»£çš„å›æ”¶è¡Œä¸ºï¼Œæˆ‘ä»¬éœ€è¦åœ¨å¯¹è¿™ä¸ªåº”ç”¨ç¨‹åºçš„å¹´è½»ä»£å †å†…å­˜æ”¹ä¸º`5M`

```text
-XX:NewSize=5M -XX:MaxNewSize=5M -XX:InitialHeapSize=10M -XX:MaxHeapSize=10M -XX:SurvivorRatio=8 -XX:PretenureSizeThreshold=10M -XX:+UseParNewGC -XX:+UseConcMarkSweepGC -XX:+PrintGCDetails -XX:+PrintGCTimeStamps
```

è¾“å‡ºç»“æœå¦‚ä¸‹ï¼Œå¯ä»¥çœ‹åˆ°åœ¨1så¤šå°±é¢‘ç¹çš„`Minor GC`ã€‚

![åœ¨è¿™é‡Œæ’å…¥å›¾ç‰‡æè¿°](https://qiniuyun.sharkchili.com/img202304071111509.png)

### [#](https://www.sharkchili.com/pages/3361b8/#ä¿®å¤å¹¶è§£å†³é—®é¢˜)ä¿®å¤å¹¶è§£å†³é—®é¢˜

æˆ‘ä»¬ä¸å¦¨å°†å¹´è½»ä»£å’Œè€å¹´ä»£ã€åˆå§‹åŒ–å †åŒºçš„ç©ºé—´éƒ½æ‰©å¤§ï¼Œå¦‚ä¸‹æ‰€ç¤º

```text
-XX:NewSize=10M -XX:MaxNewSize=10M -XX:InitialHeapSize=100M -XX:MaxHeapSize=100M -XX:SurvivorRatio=8 -XX:PretenureSizeThreshold=10M -XX:+UseParNewGC -XX:+UseConcMarkSweepGC -XX:+PrintGCDetails -XX:+PrintGCTimeStamps
```

è¾“å‡ºç»“æœï¼Œå¯ä»¥çœ‹åˆ°å‘ç”Ÿ`GC`çš„æ—¶é—´é—´éš”æ˜æ˜¾é•¿äº†ã€‚

![åœ¨è¿™é‡Œæ’å…¥å›¾ç‰‡æè¿°](https://qiniuyun.sharkchili.com/img202304071111220.png)

### [#](https://www.sharkchili.com/pages/3361b8/#å°†å¹´è½»ä»£ç©ºé—´è°ƒå¤§-æ˜¯å¦ä¼šæ›´åŠ è€—æ—¶)å°†å¹´è½»ä»£ç©ºé—´è°ƒå¤§ï¼Œæ˜¯å¦ä¼šæ›´åŠ è€—æ—¶ï¼Ÿ

ç­”æ¡ˆæ˜¯ä¸ä¼šçš„ï¼Œæˆ‘ä»¬å°†ä¸€æ¬¡`GC`çš„æ—¶é—´æ‹†åˆ†ä¸º`t1`å’Œ`t2`ï¼Œ`t1`æ˜¯æ‰«æå¹´è½»ä»£ç©ºé—´æ˜¯å¦æœ‰åƒåœ¾çš„æ—¶é—´ï¼Œè¿™ä¸ªæ—¶é—´çš„å‡ ä¹å¯ä»¥å¿½ç•¥ä¸è®¡ã€‚è€Œt2åˆ™æ˜¯å°†`eden`ç©ºé—´å­˜æ´»çš„å¯¹è±¡å¤åˆ¶åˆ°`survivor`åŒºçš„æ—¶é—´ï¼Œè¿™ä¸ªå¤åˆ¶æ“ä½œåˆ™æ˜¯t1æ—¶é—´çš„10å€ã€‚ å¾ˆæ˜æ˜¾çš„ï¼ŒJVMçš„æ€§èƒ½ç“¶é¢ˆæ˜¯t2`(æ‹·è´å­˜æ´»å¯¹è±¡åˆ°såŒº)`ï¼Œæ‰€ä»¥å¢åŠ å¹´è½»ä»£ç©ºé—´é¿å…æ²¡å¿…è¦çš„æ‹·è´æ˜¯æ­£ç¡®çš„åšæ³•ã€‚

![åœ¨è¿™é‡Œæ’å…¥å›¾ç‰‡æè¿°](https://qiniuyun.sharkchili.com/img202304071111199.png)

## [#](https://www.sharkchili.com/pages/3361b8/#å®è·µ-é¢‘ç¹çš„full-gc)(å®è·µ)é¢‘ç¹çš„FULL GC

### [#](https://www.sharkchili.com/pages/3361b8/#ç®€ä»‹)ç®€ä»‹

`FULL GC`çš„åŸå› å³è€å¹´åŒºç©ºé—´æ»¡äº†ï¼Œéœ€è¦å®Œå®Œæ•´æ•´èµ°ä¸€éåƒåœ¾å›æ”¶äº†ã€‚æ³¨æ„`FULL GC`å¯èƒ½ä¼šå¯¼è‡´æ•´ä¸ªåº”ç”¨ç¨‹åºé˜»å¡ã€‚

### [#](https://www.sharkchili.com/pages/3361b8/#é‡ç‚¹-äº†è§£cms-gcæ—¥å¿—)(é‡ç‚¹)äº†è§£CMS GCæ—¥å¿—

åœ¨è¿›è¡ŒFULL GCé—®é¢˜å®è·µä¹‹å‰ï¼Œæˆ‘ä»¬å¿…é¡»äº†è§£ä¸€ä¸‹CMS GCçš„ä¸ƒå¤§é˜¶æ®µ:

1. `Initial Mark`:é¦–å…ˆæ˜¯åˆå§‹åŒ–æ ‡è®°é˜¶æ®µï¼Œè¿™ä¸ªé˜¶æ®µæ˜¯STW`(stop the worldå³æ‰€æœ‰çº¿ç¨‹åœæ­¢å·¥ä½œ)`ï¼Œå®ƒä¼šæ ‡è®°å‡ºè€å¹´ä»£ä¸­æ‰€æœ‰çš„`GC Roots`ä»¥åŠè¢«å¹´è½»ä»£ä¸­å­˜æ´»çš„å¯¹è±¡å¼•ç”¨çš„å¯¹è±¡ã€‚

![åœ¨è¿™é‡Œæ’å…¥å›¾ç‰‡æè¿°](https://qiniuyun.sharkchili.com/img202304071111673.png)

æ—¥å¿—èŒƒä¾‹:

![åœ¨è¿™é‡Œæ’å…¥å›¾ç‰‡æè¿°](https://qiniuyun.sharkchili.com/img202304071111054.png)

1. `Concurrent Mark`:æ ¹æ®ä¸Šä¸€ä¸ªé˜¶æ®µå¾—åˆ°çš„`GC Roots`ï¼Œéå†æ‰¾å‡ºæ•´ä¸ªè€å¹´ä»£ä¸­å­˜æ´»çš„å¯¹è±¡ï¼Œæ³¨æ„è¯¥é˜¶æ®µæ˜¯å’Œåº”ç”¨ç¨‹åºçº¿ç¨‹ä¸€èµ·æ‰§è¡Œçš„ã€‚

![åœ¨è¿™é‡Œæ’å…¥å›¾ç‰‡æè¿°](https://qiniuyun.sharkchili.com/img202304071111192.png)

æ—¥å¿—èŒƒä¾‹:

![åœ¨è¿™é‡Œæ’å…¥å›¾ç‰‡æè¿°](https://qiniuyun.sharkchili.com/img202304071111115.png)

1. `Concurrent Mark`:è¿™ä¸ªé˜¶æ®µä¹Ÿæ˜¯å’Œåº”ç”¨ç¨‹åºçº¿ç¨‹å¹¶å‘å·¥ä½œçš„ï¼Œå®ƒä¼šå°†ä¸Šä¸€é˜¶æ®µè¿è¡ŒæœŸé—´å¼•ç”¨å…³ç³»å‘ç”Ÿå˜åŒ–çš„å¯¹è±¡æ ‡è®°ä¸º`Dirty Card`ã€‚

![åœ¨è¿™é‡Œæ’å…¥å›¾ç‰‡æè¿°](https://qiniuyun.sharkchili.com/img202304071111707.png)

1. `Concurrent Abortable Preclean`:è¯¥é˜¶æ®µä¹Ÿæ˜¯å’Œåº”ç”¨ç¨‹åºçº¿ç¨‹å¹¶å‘æ‰§è¡Œçš„ï¼Œå®ƒä¼šå°è¯•ç€å»æ‰¿æ‹…åç»­`STW`çš„`Final Remark`é˜¶æ®µçš„å·¥ä½œã€‚

æ—¥å¿—èŒƒä¾‹ï¼š

![åœ¨è¿™é‡Œæ’å…¥å›¾ç‰‡æè¿°](https://qiniuyun.sharkchili.com/img202304071111708.png)

1. `Final Remark`:è¿™ä¸ªé˜¶æ®µæ˜¯`STW`çš„ï¼Œä¼šæ ‡è®°å‡ºè€å¹´ä»£ä¸­æ‰€æœ‰å­˜æ´»çš„å¯¹è±¡ã€‚

æ—¥å¿—èŒƒä¾‹

![åœ¨è¿™é‡Œæ’å…¥å›¾ç‰‡æè¿°](https://qiniuyun.sharkchili.com/img202304071111459.png)

1. Concurrent Sweep:å’Œåº”ç”¨ç¨‹åºçº¿ç¨‹åŒæ—¶è¿›è¡Œï¼Œç§»é™¤é‚£äº›ä¸éœ€è¦çš„å¯¹è±¡ï¼Œé‡Šæ”¾ç©ºé—´ã€‚

![åœ¨è¿™é‡Œæ’å…¥å›¾ç‰‡æè¿°](https://qiniuyun.sharkchili.com/img202304071111737.png)

æ—¥å¿—èŒƒä¾‹:

![åœ¨è¿™é‡Œæ’å…¥å›¾ç‰‡æè¿°](https://qiniuyun.sharkchili.com/img202304071111623.png)

1. `Concurrent Reset`:è¿™ä¸ªé˜¶æ®µå¹¶å‘æ‰§è¡Œï¼Œé‡æ–°è®¾ç½®CMSç®—æ³•å†…éƒ¨çš„æ•°æ®ç»“æ„ï¼Œå‡†å¤‡ä¸‹ä¸€ä¸ªCMSç”Ÿå‘½å‘¨æœŸçš„ä½¿ç”¨ã€‚

æ—¥å¿—èŒƒä¾‹:

![åœ¨è¿™é‡Œæ’å…¥å›¾ç‰‡æè¿°](https://qiniuyun.sharkchili.com/img202304071111820.png)

### [#](https://www.sharkchili.com/pages/3361b8/#é—®é¢˜å¤ç°)é—®é¢˜å¤ç°

æˆ‘ä»¬ç°åœ¨æ¨¡æ‹Ÿä¸€ä¸ªåœºæ™¯ï¼Œæˆ‘ä»¬çš„webåº”ç”¨ä¸­æœ‰ä¸€ä¸ªå®šæ—¶ä»»åŠ¡ï¼Œè¿™ä¸ªå®šæ—¶ä»»åŠ¡æ¯éš”1sä¼šæƒ³å¦ä¸€ä¸ªå®šæ—¶ä»»åŠ¡çº¿ç¨‹æ± ä¸­æäº¤100ä¸ªä»»åŠ¡ã€‚

æ³¨æ„spring bootåº”ç”¨è¦æƒ³å¼€å¯å®šæ—¶ä»»åŠ¡å¿…é¡»æ·»åŠ `@EnableScheduling`æ³¨è§£ã€‚

ä»£ç å¦‚ä¸‹æ‰€ç¤º:

```java
@Component
public class Task {
    private static Logger logger = LoggerFactory.getLogger(Task.class);


    private static final ScheduledThreadPoolExecutor executor =
            new ScheduledThreadPoolExecutor(50,
                    new ThreadPoolExecutor.DiscardOldestPolicy());

	
    private static class Obj {
        private String name = "name";
        private int age = 18;
        private String gender = "man";
        private LocalDate birthday = LocalDate.MAX;

        public void func() {
            //è¿™ä¸ªæ–¹æ³•ä»€ä¹ˆä¹Ÿä¸åš
        }

		//è¿”å›countä¸ªObjå¯¹è±¡
        private static List<Obj> getObjList(int count) {

            List<Obj> objList = new ArrayList<>(count);

            for (int i = 0; i != count; ++i) {
                objList.add(new Obj());
            }
            return objList;
        }
    }

    @Scheduled(cron = "0/1 * *  * * ? ")   //æ¯1ç§’æ‰§è¡Œä¸€æ¬¡
    public void execute() {
        logger.info("1sä¸€æ¬¡å®šæ—¶ä»»åŠ¡");
        //å‘çº¿ç¨‹æ± æäº¤100ä¸ªä»»åŠ¡
        Obj.getObjList(100).forEach(i -> executor.scheduleWithFixedDelay(
                i::func, 2, 3, TimeUnit.SECONDS
        ));
    }
}
```

å®Œæˆåæˆ‘ä»¬è®¾ç½®ä¸‹é¢è¿™æ®µ`JVM`å‚æ•°åï¼Œå°†å…¶å¯åŠ¨

```java
-Xms20M -Xmx20M -XX:+UseParNewGC -XX:+UseConcMarkSweepGC -XX:+PrintGCDetails -XX:+PrintGCTimeStamps
```

ä¸ä¹…åï¼Œæ§åˆ¶å°å‡ºç°å¤§é‡çš„`CMS GC`æ—¥å¿—:

```java
1288.111: [GC (CMS Initial Mark) [1 CMS-initial-mark: 13695K(13696K)] 19836K(19840K), 0.0058731 secs] [Times: user=0.00 sys=0.00, real=0.01 secs] 
1288.117: [CMS-concurrent-mark-start]
1288.130: [CMS-concurrent-mark: 0.013/0.013 secs] [Times: user=0.05 sys=0.02, real=0.01 secs] 
1288.130: [CMS-concurrent-preclean-start]
1288.133: [Full GC (Allocation Failure) 1288.133: [CMS1288.142: [CMS-concurrent-preclean: 0.012/0.012 secs] [Times: user=0.01 sys=0.00, real=0.01 secs] 
 (concurrent mode failure): 13695K->13695K(13696K), 0.0610050 secs] 19839K->19836K(19840K), [Metaspace: 29026K->29026K(1077248K)], 0.0610521 secs] [Times: user=0.06 sys=0.00, real=0.06 secs] 
1288.258: [Full GC (Allocation Failure) 1288.258: [CMS: 13695K->13695K(13696K), 0.0612134 secs] 19839K->19836K(19840K), [Metaspace: 29026K->29026K(1077248K)], 0.0612676 secs] [Times: user=0.06 sys=0.00, real=0.06 secs] 
1288.320: [GC (CMS Initial Mark) [1 CMS-initial-mark: 13695K(13696K)] 19836K(19840K), 0.0041303 secs] [Times: user=0.03 sys=0.00, real=0.00 secs] 
1288.324: [CMS-concurrent-mark-start]
1288.339: [CMS-concurrent-mark: 0.015/0.015 secs] [Times: user=0.03 sys=0.00, real=0.01 secs] 
1288.339: [CMS-concurrent-preclean-start]
1288.348: [CMS-concurrent-preclean: 0.009/0.009 secs] [Times: user=0.00 sys=0.00, real=0.01 secs] 
1288.348: [CMS-concurrent-abortable-preclean-start]
1288.348: [CMS-concurrent-abortable-preclean: 0.000/0.000 secs] [Times: user=0.00 sys=0.00, real=0.00 secs] 
1288.348: [GC (CMS Final Remark) [YG occupancy: 6142 K (6144 K)]1288.348: [Rescan (parallel) , 0.0038030 secs]1288.352: [weak refs processing, 0.0000311 secs]1288.352: [class unloading, 0.0024908 secs]1288.355: [scrub symbol table, 0.0042932 secs]1288.359: [scrub string table, 0.0002748 secs][1 CMS-remark: 13695K(13696K)] 19838K(19840K), 0.0109811 secs] [Times: user=0.02 sys=0.00, real=0.01 secs] 
1288.360: [CMS-concurrent-sweep-start]
1288.364: [CMS-concurrent-sweep: 0.005/0.005 secs] [Times: user=0.00 sys=0.00, real=0.00 secs] 
1288.364: [CMS-concurrent-reset-start]
1288.364: [CMS-concurrent-reset: 0.000/0.000 secs] [Times: user=0.00 sys=0.00, real=0.00 secs] 
1288.384: [GC (Allocation Failure) 1288.384: [ParNew: 6143K->6143K(6144K), 0.0000365 secs]1288.384: [CMS: 13695K->13695K(13696K), 0.0540105 secs] 19839K->19836K(19840K), [Metaspace: 29026K->29026K(1077248K)], 0.0541242 secs] [Times: user=0.05 sys=0.00, real=0.05 secs] 
```

### [#](https://www.sharkchili.com/pages/3361b8/#æ’æŸ¥æ€è·¯)æ’æŸ¥æ€è·¯

éšç€æ—¶é—´çš„æ¨ç§»ï¼Œæˆ‘ä»¬å‘ç°æ§åˆ¶å°å‡ºç°äº†å¤§é‡FULL GC`(å¦‚æœæ˜¯ç”Ÿäº§ç¯å¢ƒï¼Œå¯èƒ½æœåŠ¡çš„å“åº”é€Ÿåº¦ä¼šéå¸¸æ…¢)`ï¼Œæ‰€ä»¥æˆ‘ä»¬é¦–å…ˆéœ€è¦å®šä½è¿™ä¸ªè¿›ç¨‹çš„pidï¼Œé¦–å…ˆåœ¨æ§åˆ¶å°è¾“å…¥`jps`æ‰¾åˆ°è¿›ç¨‹ï¼Œè¾“å‡ºå¦‚ä¸‹ç»“æœï¼Œå¯ä»¥çœ‹åˆ°è¿™ä¸ª`pid`ä¸º`7476`ã€‚

```java
10848 KotlinCompileDaemon
4832 Jps
7476 JstackTestApplication
8856 RemoteMavenServer
```

ç„¶åæˆ‘ä»¬ä½¿ç”¨`jstat`è§‚å¯Ÿå…¶`gc`æƒ…å†µ,å¦‚ä¸‹æ‰€ç¤ºï¼Œå¯ä»¥çœ‹åˆ°æ¯éš”`10s`ï¼Œå°±ä¼šå¢åŠ å¤§é‡çš„`FULL GC`

```java
C:\Users\xxx>jstat -gc 7476 10000 10
 S0C    S1C    S0U    S1U      EC       EU        OC         OU       MC     MU    CCSC   CCSU   YGC     YGCT    FGC    FGCT     GCT
640.0  640.0   0.0   640.0   5504.0   665.5    13696.0    11176.2   31488.0 28992.6 4352.0 3889.5     39    0.084  15      0.100    0.184
640.0  640.0   0.0   640.0   5504.0   1487.2   13696.0    11176.2   31488.0 28992.6 4352.0 3889.5     39    0.084  25      0.142    0.227
640.0  640.0   0.0   640.0   5504.0   1697.8   13696.0    11176.2   31488.0 28992.6 4352.0 3889.5     39    0.084  35      0.185    0.269
640.0  640.0   0.0   640.0   5504.0   2380.4   13696.0    11176.2   31488.0 28992.6 4352.0 3889.5     39    0.084  41      0.249    0.334
640.0  640.0   0.0   640.0   5504.0   3063.0   13696.0    11176.2   31488.0 28992.6 4352.0 3889.5     39    0.084  44      0.260    0.345
640.0  640.0   0.0   640.0   5504.0   3745.6   13696.0    11176.2   31488.0 28992.6 4352.0 3889.5     39    0.084  46      0.270    0.355
640.0  640.0   0.0   640.0   5504.0   4342.6   13696.0    11176.2   31488.0 28992.6 4352.0 3889.5     39    0.084  50      0.297    0.382
```

å†æŸ¥çœ‹`jmap`æŸ¥çœ‹å †åŒºä½¿ç”¨æƒ…å†µ

```go
 jmap -heap 7476 
Attaching to process ID 26176, please wait...
Debugger attached successfully.
Server compiler detected.
JVM version is 25.212-b10

using parallel threads in the new generation.
using thread-local object allocation.
Concurrent Mark-Sweep GC

Heap Configuration:
   MinHeapFreeRatio         = 40
   MaxHeapFreeRatio         = 70
   MaxHeapSize              = 20971520 (20.0MB)
   NewSize                  = 6946816 (6.625MB)
   MaxNewSize               = 6946816 (6.625MB)
   OldSize                  = 14024704 (13.375MB)
   NewRatio                 = 2
   SurvivorRatio            = 8
   MetaspaceSize            = 21807104 (20.796875MB)
   CompressedClassSpaceSize = 1073741824 (1024.0MB)
   MaxMetaspaceSize         = 17592186044415 MB
   G1HeapRegionSize         = 0 (0.0MB)

Heap Usage:
New Generation (Eden + 1 Survivor Space):
   capacity = 6291456 (6.0MB)
   used     = 5088288 (4.852569580078125MB)
   free     = 1203168 (1.147430419921875MB)
   80.87615966796875% used
Eden Space:
   capacity = 5636096 (5.375MB)
   used     = 5088288 (4.852569580078125MB)
   free     = 547808 (0.522430419921875MB)
   90.28036428052326% used
From Space:
   capacity = 655360 (0.625MB)
   used     = 0 (0.0MB)
   free     = 655360 (0.625MB)
   0.0% used
To Space:
   capacity = 655360 (0.625MB)
   used     = 0 (0.0MB)
   free     = 655360 (0.625MB)
   0.0% used
concurrent mark-sweep generation:
   capacity = 14024704 (13.375MB)
   used     = 13819664 (13.179458618164062MB)
   free     = 205040 (0.1955413818359375MB)
   98.53800836010514% used

12064 interned Strings occupying 1120288 bytes.
```

åœ¨æ’é™¤å†…å­˜æ³„æ¼çš„é—®é¢˜åï¼Œæˆ‘ä»¬é€šè¿‡`jstack`å®šä½è¿›ç¨‹ä¸­å¯¼è‡´æ˜¯ä»€ä¹ˆå¯¹è±¡å¯¼è‡´è€å¹´ä»£å †åŒºè¢«å¤§é‡å ç”¨ï¼Œå¦‚ä¸‹æ‰€ç¤ºå¯ä»¥çœ‹åˆ°å‰20åä¸­çš„å¯¹è±¡éƒ½æ˜¯å’Œå®šæ—¶ä»»åŠ¡ç›¸å…³ï¼Œæœ‰ä¸€ä¸ª`Task$Obj`å¯¹è±¡éå¸¸æŠ¢çœ¼ï¼Œå¾ˆæ˜æ˜¾å°±æ˜¯å› ä¸ºå®ƒçš„æ•°é‡è¿‡å¤šå¯¼è‡´çš„ï¼Œæ­¤æ—¶æˆ‘ä»¬å°±å¯ä»¥é€šè¿‡å®šä½ä»£ç ç¡®å®šå¦‚ä½•è§£å†³ï¼Œå¸¸è§æ–¹æ¡ˆæ— éæ˜¯: ä¼˜åŒ–ä»£ç ã€å¢åŠ ç©ºé—´ä¸¤ç§æ–¹å¼ï¼Œä¸€èˆ¬æ¥è¯´æˆ‘ä»¬éƒ½ä¼šé‡‡ç”¨ä»£ç ä¼˜åŒ–çš„æ–¹å¼å»è§£å†³ã€‚

```java
$ jmap -histo 7476 | head -n 20

 num     #instances         #bytes  class name
----------------------------------------------
   1:         50760        3654720  java.util.concurrent.ScheduledThreadPoolExecutor$ScheduledFutureTask
   2:         30799        2901552  [C
   3:         88986        2847552  java.util.concurrent.locks.AbstractQueuedSynchronizer$Node
   4:         50700        1622400  com.example.jstackTest.Task$Obj
   5:         50760        1218240  java.util.concurrent.Executors$RunnableAdapter
   6:         50700         811200  com.example.jstackTest.Task$$Lambda$587/1605553313
   7:          6391         707928  java.lang.Class
   8:         29256         702144  java.lang.String
   9:         13577         434464  java.util.concurrent.ConcurrentHashMap$Node
  10:          6363         341016  [Ljava.lang.Object;
  11:          1722         312440  [B
  12:          3414         230424  [I
  13:             4         210680  [Ljava.util.concurrent.RunnableScheduledFuture;
  14:          5223         208920  java.util.LinkedHashMap$Entry
  15:          2297         202136  java.lang.reflect.Method
  16:          2262         193760  [Ljava.util.HashMap$Node;
  17:          5668         181376  java.util.HashMap$Node
```

è€Œæœ¬æ¬¡é—®é¢˜ä¹Ÿå¾ˆæ˜æ˜¾ï¼Œä»»åŠ¡æ˜¯ä¸€ä¸ªä¸ªæäº¤åˆ°å®šæ—¶ä»»åŠ¡çº¿ç¨‹æ± ä¸­ï¼Œæ˜¯ç”±äºå®šæ—¶ä»»åŠ¡é˜Ÿåˆ—`DelayedWorkQueue`ä¸æ–­å †ç§¯ä»»åŠ¡å¯¼è‡´å†…å­˜è¢«æ‰“æ»¡ã€‚æ‰€ä»¥æœ€ç»ˆæ”¹æˆå°†ä¸€ä¸ªæ‰¹æ“ä½œä¸€æ¬¡æ€§æäº¤åˆ°å®šæ—¶ä»»åŠ¡ä¸­å¾—ä»¥è§£å†³

```go
 @Scheduled(cron = "0/1 * *  * * ? ")   //æ¯1ç§’æ‰§è¡Œä¸€æ¬¡
    public void execute() {
        logger.info("1sä¸€æ¬¡å®šæ—¶ä»»åŠ¡");
        //å‘çº¿ç¨‹æ± æäº¤100ä¸ªä»»åŠ¡


        executor.scheduleWithFixedDelay(() -> {
                    Obj.getObjList(100).forEach(i -> i.func());
                }, 2, 3, TimeUnit.SECONDS
        );


    }
```

### [#](https://www.sharkchili.com/pages/3361b8/#è¡¥å……-å¯¼è‡´é¢‘ç¹full-gcä¸‰å¤§åŸå› )è¡¥å……:å¯¼è‡´é¢‘ç¹FULL GCä¸‰å¤§åŸå› 

æˆ‘ä»¬éœ€è¦éœ€è¦å…·ä½“åˆ†ææ‰èƒ½å¾—å‡ºè§£å†³æ–¹æ¡ˆï¼Œæ€»çš„æ¥è¯´åŸå› å¯ä»¥åˆ†ä¸º3ä¸ª:

1. ç”¨æˆ·é¢‘ç¹è°ƒç”¨`System.gc()`:è¿™ç§æƒ…å†µéœ€è¦ä¿®æ”¹ä»£ç å³å¯ï¼Œæˆ‘ä»¬ä¸è¯¥é¢‘ç¹è°ƒç”¨è¿™ä¸ªæ–¹æ³•çš„ã€‚
2. è€å¹´åŒºç©ºé—´è¿‡å°:è§†æƒ…å†µé€‚å½“æ‰©å¤§ç©ºé—´ã€‚
3. å¤§å¯¹è±¡è¿‡å¤š:è¿™ç§æƒ…å†µè§†æƒ…å†µå†³å®šæ˜¯æ‰©å¤§è€å¹´ä»£ç©ºé—´æˆ–è€…å°†å¤§å¯¹è±¡æ‹†åˆ†ã€‚

## [#](https://www.sharkchili.com/pages/3361b8/#æ›´å¤šjvmè°ƒä¼˜)æ›´å¤šJVMè°ƒä¼˜

[ä»å®é™…æ¡ˆä¾‹èŠèŠJavaåº”ç”¨çš„GCä¼˜åŒ–(opens new window)](https://tech.meituan.com/2017/12/29/jvm-optimize.html)

[Javaä¸­9ç§å¸¸è§çš„CMS GCé—®é¢˜åˆ†æä¸è§£å†³(opens new window)](https://tech.meituan.com/2020/11/12/java-9-cms-gc.html)

[å¬è¯´ JVM æ€§èƒ½ä¼˜åŒ–å¾ˆéš¾ï¼Ÿä»Šå¤©æˆ‘å°è¯•äº†ä¸€æŠŠï¼(opens new window)](https://shuyi.tech/archives/have-a-try-in-jvm-combat)

[ä¸€æ¬¡çº¿ä¸ŠJVMè°ƒä¼˜å®è·µï¼ŒFullGC40æ¬¡/å¤©åˆ°10å¤©ä¸€æ¬¡çš„ä¼˜åŒ–è¿‡ç¨‹(opens new window)](https://heapdump.cn/article/1859160)

[çº¿ä¸Šé¢‘ç¹å‘ç”ŸFull GC å¦‚ä½•è°ƒä¼˜ï¼Ÿå¦‚ä½•å¿«é€Ÿå®šä½OOMã€cpué£™å‡ã€çº¿ç¨‹æ­»é”ç­‰é—®é¢˜(opens new window)](https://blog.51cto.com/u_15281317/3008860)

## [#](https://www.sharkchili.com/pages/3361b8/#å‚è€ƒæ–‡çŒ®)å‚è€ƒæ–‡çŒ®

[JVMå­¦ä¹ ï¼ˆ7ï¼‰Stop-The-World(opens new window)](https://www.jianshu.com/p/d686e108d15f)

[JVMè°ƒä¼˜â€”â€”ä¹‹CMS GCæ—¥å¿—åˆ†æ (opens new window)](https://www.cnblogs.com/onmyway20xx/p/6590603.html)

[ä»å®é™…æ¡ˆä¾‹èŠèŠJavaåº”ç”¨çš„GCä¼˜åŒ–(opens new window)](https://tech.meituan.com/2017/12/29/jvm-optimize.html#:~:text= é€šå¸¸æƒ…å†µä¸‹ï¼Œç”±äºæ–°ç”Ÿä»£ç©ºé—´è¾ƒå°ï¼ŒEdenåŒºå¾ˆå¿«è¢«å¡«æ»¡ï¼Œå°±ä¼šå¯¼è‡´é¢‘ç¹Minor GCï¼Œå› æ­¤å¯ä»¥é€šè¿‡å¢å¤§æ–°ç”Ÿä»£ç©ºé—´æ¥é™ä½Minor,GCçš„é¢‘ç‡ã€‚ ä¾‹å¦‚åœ¨ç›¸åŒçš„å†…å­˜åˆ†é…ç‡çš„å‰æä¸‹ï¼Œæ–°ç”Ÿä»£ä¸­çš„EdenåŒºå¢åŠ ä¸€å€ï¼ŒMinor GCçš„æ¬¡æ•°å°±ä¼šå‡å°‘ä¸€åŠã€‚)

[Spring Bootå®šæ—¶ä»»åŠ¡è¯¦è§£ï¼ˆçº¿ç¨‹æ± æ–¹å¼ï¼‰(opens new window)](https://blog.csdn.net/Alian_1223/article/details/120455623)

[SpringBootä½¿ç”¨@Scheduledæ³¨è§£å®ç°å®šæ—¶ä»»åŠ¡(opens new window)](https://blog.csdn.net/pan_junbiao/article/details/109399280)

[é¢æ¸£é€†è¢­ï¼ˆJava è™šæ‹Ÿæœº-JVMé¢è¯•é¢˜å…«è‚¡æ–‡ï¼‰å¿…çœ‹ğŸ‘](https://tobebetterjavaer.com/sidebar/sanfene/jvm.html#_39-é¢‘ç¹-full-gc-æ€ä¹ˆåŠ)











# å›¾çµ

**å‰ç½®å¯åŠ¨ç¨‹åº**

äº‹å…ˆå¯åŠ¨ä¸€ä¸ªwebåº”ç”¨ç¨‹åºï¼Œç”¨jpsæŸ¥çœ‹å…¶è¿›ç¨‹idï¼Œæ¥ç€ç”¨å„ç§jdkè‡ªå¸¦å‘½ä»¤ä¼˜åŒ–åº”ç”¨

**Jmap**

æ­¤å‘½ä»¤å¯ä»¥ç”¨æ¥æŸ¥çœ‹å†…å­˜ä¿¡æ¯ï¼Œå®ä¾‹ä¸ªæ•°ä»¥åŠå ç”¨å†…å­˜å¤§å°

â€‹    ![0](https://note.youdao.com/yws/public/resource/5cc182642eb02bc64197788c7722baae/xmlnote/EC84D5FEA98348298810AA1F885943EE/96322)

â€‹                jmap -histo 14660  #æŸ¥çœ‹å†å²ç”Ÿæˆçš„å®ä¾‹ jmap -histo:live 14660  #æŸ¥çœ‹å½“å‰å­˜æ´»çš„å®ä¾‹ï¼Œæ‰§è¡Œè¿‡ç¨‹ä¸­å¯èƒ½ä¼šè§¦å‘ä¸€æ¬¡full gc              

æ‰“å¼€log.txtï¼Œæ–‡ä»¶å†…å®¹å¦‚ä¸‹ï¼š

â€‹    ![0](https://note.youdao.com/yws/public/resource/5cc182642eb02bc64197788c7722baae/xmlnote/B6CBAEA18BA34FF3BC25D03D3933A7D2/96302)

- numï¼šåºå·
- instancesï¼šå®ä¾‹æ•°é‡
- bytesï¼šå ç”¨ç©ºé—´å¤§å°
- class nameï¼šç±»åç§°ï¼Œ[C is a char[]ï¼Œ[S is a short[]ï¼Œ[I is a int[]ï¼Œ[B is a byte[]ï¼Œ[[I is a int[][]

å †ä¿¡æ¯

â€‹    ![0](https://note.youdao.com/yws/public/resource/5cc182642eb02bc64197788c7722baae/xmlnote/7273899836004DFD8921CB96ADA63635/96304)

å †å†…å­˜dump

â€‹                jmap -dump:format=b,file=eureka.hprof 14660              

â€‹    ![0](https://note.youdao.com/yws/public/resource/5cc182642eb02bc64197788c7722baae/xmlnote/096CD3DF5F8C465D9294E86C331013B8/96320)

ä¹Ÿå¯ä»¥è®¾ç½®å†…å­˜æº¢å‡ºè‡ªåŠ¨å¯¼å‡ºdumpæ–‡ä»¶(å†…å­˜å¾ˆå¤§çš„æ—¶å€™ï¼Œå¯èƒ½ä¼šå¯¼ä¸å‡ºæ¥)

1. -XX:+HeapDumpOnOutOfMemoryError
2. -XX:HeapDumpPath=./  ï¼ˆè·¯å¾„ï¼‰

ç¤ºä¾‹ä»£ç ï¼š

â€‹                public class OOMTest {    public static List<Object> list = new ArrayList<>();    // JVMè®¾ç½®     // -Xms10M -Xmx10M -XX:+PrintGCDetails -XX:+HeapDumpOnOutOfMemoryError -XX:HeapDumpPath=D:\jvm.dump    public static void main(String[] args) {      List<Object> list = new ArrayList<>();      int i = 0;      int j = 0;      while (true) {         list.add(new User(i++, UUID.randomUUID().toString()));         new User(j--, UUID.randomUUID().toString());      }   } }              

**å¯ä»¥ç”¨jvisualvmå‘½ä»¤å·¥å…·å¯¼å…¥è¯¥dumpæ–‡ä»¶åˆ†æ**

â€‹    ![0](https://note.youdao.com/yws/public/resource/5cc182642eb02bc64197788c7722baae/xmlnote/D87038046C0A4BE99461BD577017A3D4/96300)

**Jstack**

ç”¨jstackåŠ è¿›ç¨‹idæŸ¥æ‰¾æ­»é”ï¼Œè§å¦‚ä¸‹ç¤ºä¾‹

â€‹                public class DeadLockTest {    private static Object lock1 = new Object();   private static Object lock2 = new Object();    public static void main(String[] args) {      new Thread(() -> {         synchronized (lock1) {            try {               System.out.println("thread1 begin");               Thread.sleep(5000);            } catch (InterruptedException e) {            }            synchronized (lock2) {               System.out.println("thread1 end");            }         }      }).start();       new Thread(() -> {         synchronized (lock2) {            try {               System.out.println("thread2 begin");               Thread.sleep(5000);            } catch (InterruptedException e) {            }            synchronized (lock1) {               System.out.println("thread2 end");            }         }      }).start();       System.out.println("main thread end");   } }              

â€‹    ![0](https://note.youdao.com/yws/public/resource/5cc182642eb02bc64197788c7722baae/xmlnote/4FB8482FD6954EB58256FFDE72FAF417/96306)

"Thread-1" çº¿ç¨‹å 

prio=5 ä¼˜å…ˆçº§=5

tid=0x000000001fa9e000 çº¿ç¨‹id

nid=0x2d64 çº¿ç¨‹å¯¹åº”çš„æœ¬åœ°çº¿ç¨‹æ ‡è¯†nid

java.lang.Thread.State: BLOCKED çº¿ç¨‹çŠ¶æ€

â€‹    ![0](https://note.youdao.com/yws/public/resource/5cc182642eb02bc64197788c7722baae/xmlnote/57C9722B794F4473AAEBFA92831214B2/96308)

è¿˜å¯ä»¥ç”¨jvisualvmè‡ªåŠ¨æ£€æµ‹æ­»é”

â€‹    ![0](https://note.youdao.com/yws/public/resource/5cc182642eb02bc64197788c7722baae/xmlnote/107CD682F0F34039AC2AB686766D2FF4/96309)

 **è¿œç¨‹è¿æ¥jvisualvm**

**å¯åŠ¨æ™®é€šçš„jarç¨‹åºJMXç«¯å£é…ç½®ï¼š**

â€‹                java -Dcom.sun.management.jmxremote.port=8888 -Djava.rmi.server.hostname=192.168.65.60 -Dcom.sun.management.jmxremote.ssl=false -Dcom.sun.management.jmxremote.authenticate=false -jar microservice-eureka-server.jar              

PSï¼š

-Dcom.sun.management.jmxremote.port ä¸ºè¿œç¨‹æœºå™¨çš„JMXç«¯å£

-Djava.rmi.server.hostname ä¸ºè¿œç¨‹æœºå™¨IP

**tomcatçš„JMXé…ç½®ï¼šåœ¨catalina.shæ–‡ä»¶é‡Œçš„æœ€åä¸€ä¸ªJAVA_OPTSçš„èµ‹å€¼è¯­å¥ä¸‹ä¸€è¡Œå¢åŠ å¦‚ä¸‹é…ç½®è¡Œ**

â€‹                JAVA_OPTS="$JAVA_OPTS -Dcom.sun.management.jmxremote.port=8888 -Djava.rmi.server.hostname=192.168.50.60 -Dcom.sun.management.jmxremote.ssl=false -Dcom.sun.management.jmxremote.authenticate=false"              

è¿æ¥æ—¶ç¡®è®¤ä¸‹ç«¯å£æ˜¯å¦é€šç•…ï¼Œå¯ä»¥ä¸´æ—¶å…³é—­ä¸‹é˜²ç«å¢™

â€‹                systemctl stop firewalld   #ä¸´æ—¶å…³é—­é˜²ç«å¢™              

**jstackæ‰¾å‡ºå ç”¨cpuæœ€é«˜çš„çº¿ç¨‹å †æ ˆä¿¡æ¯**

â€‹                package com.tuling.jvm; /** * è¿è¡Œæ­¤ä»£ç ï¼Œcpuä¼šé£™é«˜ */ public class Math {     public static final int initData = 666;    public static User user = new User();     public int compute() {  //ä¸€ä¸ªæ–¹æ³•å¯¹åº”ä¸€å—æ ˆå¸§å†…å­˜åŒºåŸŸ        int a = 1;        int b = 2;        int c = (a + b) * 10;        return c;    }     public static void main(String[] args) {        Math math = new Math();        while (true){            math.compute();        }    } }              

1ï¼Œä½¿ç”¨å‘½ä»¤top -p  ï¼Œæ˜¾ç¤ºä½ çš„javaè¿›ç¨‹çš„å†…å­˜æƒ…å†µï¼Œpidæ˜¯ä½ çš„javaè¿›ç¨‹å·ï¼Œæ¯”å¦‚19663

â€‹    ![0](https://note.youdao.com/yws/public/resource/5cc182642eb02bc64197788c7722baae/xmlnote/95F189D34BB34C09816B6D95CAB62005/96310)

2ï¼ŒæŒ‰Hï¼Œè·å–æ¯ä¸ªçº¿ç¨‹çš„å†…å­˜æƒ…å†µ 

â€‹    ![0](https://note.youdao.com/yws/public/resource/5cc182642eb02bc64197788c7722baae/xmlnote/449A8C6C90F647818D9B15E279F8DACE/96324)

3ï¼Œæ‰¾åˆ°å†…å­˜å’Œcpuå ç”¨æœ€é«˜çš„çº¿ç¨‹tidï¼Œæ¯”å¦‚19664

4ï¼Œè½¬ä¸ºåå…­è¿›åˆ¶å¾—åˆ° 0x4cd0ï¼Œæ­¤ä¸ºçº¿ç¨‹idçš„åå…­è¿›åˆ¶è¡¨ç¤º ï¼ˆtopçœ‹çš„æ˜¯æ“ä½œç³»ç»Ÿçš„çº¿ç¨‹ï¼Œè€Œjstackä¸­å±•ç¤ºçº¿ç¨‹æ—¶ï¼Œæ“ä½œç³»ç»Ÿçº¿ç¨‹å±•ç¤ºçš„æ˜¯16è¿›åˆ¶ï¼Œæ‰€ä»¥è¦è¿›è¡Œè£…æ¢ï¼‰

5ï¼Œæ‰§è¡Œ jstack 19663|grep -A 10 4cd0ï¼Œå¾—åˆ°çº¿ç¨‹å †æ ˆä¿¡æ¯ä¸­ 4cd0 è¿™ä¸ªçº¿ç¨‹æ‰€åœ¨è¡Œçš„åé¢10è¡Œï¼Œä»å †æ ˆä¸­å¯ä»¥å‘ç°å¯¼è‡´cpué£™é«˜çš„è°ƒç”¨æ–¹æ³•

â€‹    ![0](https://note.youdao.com/yws/public/resource/5cc182642eb02bc64197788c7722baae/xmlnote/90A784EAB9894E209E9161B7C17096F5/96326)

6ï¼ŒæŸ¥çœ‹å¯¹åº”çš„å †æ ˆä¿¡æ¯æ‰¾å‡ºå¯èƒ½å­˜åœ¨é—®é¢˜çš„ä»£ç 

**Jinfo** 

æŸ¥çœ‹æ­£åœ¨è¿è¡Œçš„Javaåº”ç”¨ç¨‹åºçš„æ‰©å±•å‚æ•° 

æŸ¥çœ‹jvmçš„å‚æ•°

â€‹    ![0](https://note.youdao.com/yws/public/resource/5cc182642eb02bc64197788c7722baae/xmlnote/EB491F1E07ED4209A8F340C30CE09027/96331)

æŸ¥çœ‹javaç³»ç»Ÿå‚æ•°

â€‹    ![0](https://note.youdao.com/yws/public/resource/5cc182642eb02bc64197788c7722baae/xmlnote/D45E5DDE7D044A1FBC74178FB106D34A/96333)

**Jstat**

jstatå‘½ä»¤å¯ä»¥æŸ¥çœ‹å †å†…å­˜å„éƒ¨åˆ†çš„ä½¿ç”¨é‡ï¼Œä»¥åŠåŠ è½½ç±»çš„æ•°é‡ã€‚å‘½ä»¤çš„æ ¼å¼å¦‚ä¸‹ï¼š

jstat [-å‘½ä»¤é€‰é¡¹] [vmid] [é—´éš”æ—¶é—´(æ¯«ç§’)] [æŸ¥è¯¢æ¬¡æ•°]

æ³¨æ„ï¼šä½¿ç”¨çš„jdkç‰ˆæœ¬æ˜¯jdk8

åƒåœ¾å›æ”¶ç»Ÿè®¡

**jstat -gc pid æœ€å¸¸ç”¨**ï¼Œå¯ä»¥è¯„ä¼°ç¨‹åºå†…å­˜ä½¿ç”¨åŠGCå‹åŠ›æ•´ä½“æƒ…å†µ

â€‹    ![0](https://note.youdao.com/yws/public/resource/5cc182642eb02bc64197788c7722baae/xmlnote/A1CCAEEFC56D4EE387D7EC6348C6F8BB/96314)

- S0Cï¼šç¬¬ä¸€ä¸ªå¹¸å­˜åŒºçš„å¤§å°ï¼Œå•ä½KB
- S1Cï¼šç¬¬äºŒä¸ªå¹¸å­˜åŒºçš„å¤§å°
- S0Uï¼šç¬¬ä¸€ä¸ªå¹¸å­˜åŒºçš„ä½¿ç”¨å¤§å°
- S1Uï¼šç¬¬äºŒä¸ªå¹¸å­˜åŒºçš„ä½¿ç”¨å¤§å°
- ECï¼šä¼Šç”¸å›­åŒºçš„å¤§å°
- EUï¼šä¼Šç”¸å›­åŒºçš„ä½¿ç”¨å¤§å°
- OCï¼šè€å¹´ä»£å¤§å°
- OUï¼šè€å¹´ä»£ä½¿ç”¨å¤§å°
- MCï¼šæ–¹æ³•åŒºå¤§å°(å…ƒç©ºé—´)
- MUï¼šæ–¹æ³•åŒºä½¿ç”¨å¤§å°
- CCSC:å‹ç¼©ç±»ç©ºé—´å¤§å°
- CCSU:å‹ç¼©ç±»ç©ºé—´ä½¿ç”¨å¤§å°
- YGCï¼šå¹´è½»ä»£åƒåœ¾å›æ”¶æ¬¡æ•°
- YGCTï¼šå¹´è½»ä»£åƒåœ¾å›æ”¶æ¶ˆè€—æ—¶é—´ï¼Œå•ä½s
- FGCï¼šè€å¹´ä»£åƒåœ¾å›æ”¶æ¬¡æ•° 
- FGCTï¼šè€å¹´ä»£åƒåœ¾å›æ”¶æ¶ˆè€—æ—¶é—´ï¼Œå•ä½s
- GCTï¼šåƒåœ¾å›æ”¶æ¶ˆè€—æ€»æ—¶é—´ï¼Œå•ä½s

å †å†…å­˜ç»Ÿè®¡

â€‹    ![0](https://note.youdao.com/yws/public/resource/5cc182642eb02bc64197788c7722baae/xmlnote/B82BD98F97C84A2EB0A7EA2AC86EF606/96312)

- NGCMNï¼šæ–°ç”Ÿä»£æœ€å°å®¹é‡
- NGCMXï¼šæ–°ç”Ÿä»£æœ€å¤§å®¹é‡
- NGCï¼šå½“å‰æ–°ç”Ÿä»£å®¹é‡
- S0Cï¼šç¬¬ä¸€ä¸ªå¹¸å­˜åŒºå¤§å°
- S1Cï¼šç¬¬äºŒä¸ªå¹¸å­˜åŒºçš„å¤§å°
- ECï¼šä¼Šç”¸å›­åŒºçš„å¤§å°
- OGCMNï¼šè€å¹´ä»£æœ€å°å®¹é‡
- OGCMXï¼šè€å¹´ä»£æœ€å¤§å®¹é‡
- OGCï¼šå½“å‰è€å¹´ä»£å¤§å°
- OC:å½“å‰è€å¹´ä»£å¤§å°
- MCMN:æœ€å°å…ƒæ•°æ®å®¹é‡
- MCMXï¼šæœ€å¤§å…ƒæ•°æ®å®¹é‡
- MCï¼šå½“å‰å…ƒæ•°æ®ç©ºé—´å¤§å°
- CCSMNï¼šæœ€å°å‹ç¼©ç±»ç©ºé—´å¤§å°
- CCSMXï¼šæœ€å¤§å‹ç¼©ç±»ç©ºé—´å¤§å°
- CCSCï¼šå½“å‰å‹ç¼©ç±»ç©ºé—´å¤§å°
- YGCï¼šå¹´è½»ä»£gcæ¬¡æ•°
- FGCï¼šè€å¹´ä»£GCæ¬¡æ•°

æ–°ç”Ÿä»£åƒåœ¾å›æ”¶ç»Ÿè®¡

â€‹    ![0](https://note.youdao.com/yws/public/resource/5cc182642eb02bc64197788c7722baae/xmlnote/8FECFAF1EE994EBBAEB93E1BA7E87AC9/96317)

- S0Cï¼šç¬¬ä¸€ä¸ªå¹¸å­˜åŒºçš„å¤§å°
- S1Cï¼šç¬¬äºŒä¸ªå¹¸å­˜åŒºçš„å¤§å°
- S0Uï¼šç¬¬ä¸€ä¸ªå¹¸å­˜åŒºçš„ä½¿ç”¨å¤§å°
- S1Uï¼šç¬¬äºŒä¸ªå¹¸å­˜åŒºçš„ä½¿ç”¨å¤§å°
- TT:å¯¹è±¡åœ¨æ–°ç”Ÿä»£å­˜æ´»çš„æ¬¡æ•°
- MTT:å¯¹è±¡åœ¨æ–°ç”Ÿä»£å­˜æ´»çš„æœ€å¤§æ¬¡æ•°
- DSS:æœŸæœ›çš„å¹¸å­˜åŒºå¤§å°
- ECï¼šä¼Šç”¸å›­åŒºçš„å¤§å°
- EUï¼šä¼Šç”¸å›­åŒºçš„ä½¿ç”¨å¤§å°
- YGCï¼šå¹´è½»ä»£åƒåœ¾å›æ”¶æ¬¡æ•°
- YGCTï¼šå¹´è½»ä»£åƒåœ¾å›æ”¶æ¶ˆè€—æ—¶é—´

æ–°ç”Ÿä»£å†…å­˜ç»Ÿè®¡

â€‹    ![0](https://note.youdao.com/yws/public/resource/5cc182642eb02bc64197788c7722baae/xmlnote/8E0C8BC666064276AA8CEA80BA60D219/96315)

- NGCMNï¼šæ–°ç”Ÿä»£æœ€å°å®¹é‡
- NGCMXï¼šæ–°ç”Ÿä»£æœ€å¤§å®¹é‡
- NGCï¼šå½“å‰æ–°ç”Ÿä»£å®¹é‡
- S0CMXï¼šæœ€å¤§å¹¸å­˜1åŒºå¤§å°
- S0Cï¼šå½“å‰å¹¸å­˜1åŒºå¤§å°
- S1CMXï¼šæœ€å¤§å¹¸å­˜2åŒºå¤§å°
- S1Cï¼šå½“å‰å¹¸å­˜2åŒºå¤§å°
- ECMXï¼šæœ€å¤§ä¼Šç”¸å›­åŒºå¤§å°
- ECï¼šå½“å‰ä¼Šç”¸å›­åŒºå¤§å°
- YGCï¼šå¹´è½»ä»£åƒåœ¾å›æ”¶æ¬¡æ•°
- FGCï¼šè€å¹´ä»£å›æ”¶æ¬¡æ•°

è€å¹´ä»£åƒåœ¾å›æ”¶ç»Ÿè®¡

â€‹    ![0](https://note.youdao.com/yws/public/resource/5cc182642eb02bc64197788c7722baae/xmlnote/390D87E5743D48BF9CA052A6E8652D46/96319)

- MCï¼šæ–¹æ³•åŒºå¤§å°
- MUï¼šæ–¹æ³•åŒºä½¿ç”¨å¤§å°
- CCSC:å‹ç¼©ç±»ç©ºé—´å¤§å°
- CCSU:å‹ç¼©ç±»ç©ºé—´ä½¿ç”¨å¤§å°
- OCï¼šè€å¹´ä»£å¤§å°
- OUï¼šè€å¹´ä»£ä½¿ç”¨å¤§å°
- YGCï¼šå¹´è½»ä»£åƒåœ¾å›æ”¶æ¬¡æ•°
- FGCï¼šè€å¹´ä»£åƒåœ¾å›æ”¶æ¬¡æ•°
- FGCTï¼šè€å¹´ä»£åƒåœ¾å›æ”¶æ¶ˆè€—æ—¶é—´
- GCTï¼šåƒåœ¾å›æ”¶æ¶ˆè€—æ€»æ—¶é—´

è€å¹´ä»£å†…å­˜ç»Ÿè®¡

â€‹    ![0](https://note.youdao.com/yws/public/resource/5cc182642eb02bc64197788c7722baae/xmlnote/B529A9B7E2404516942E67285253771F/96318)

- OGCMNï¼šè€å¹´ä»£æœ€å°å®¹é‡
- OGCMXï¼šè€å¹´ä»£æœ€å¤§å®¹é‡
- OGCï¼šå½“å‰è€å¹´ä»£å¤§å°
- OCï¼šè€å¹´ä»£å¤§å°
- YGCï¼šå¹´è½»ä»£åƒåœ¾å›æ”¶æ¬¡æ•°
- FGCï¼šè€å¹´ä»£åƒåœ¾å›æ”¶æ¬¡æ•°
- FGCTï¼šè€å¹´ä»£åƒåœ¾å›æ”¶æ¶ˆè€—æ—¶é—´
- GCTï¼šåƒåœ¾å›æ”¶æ¶ˆè€—æ€»æ—¶é—´

å…ƒæ•°æ®ç©ºé—´ç»Ÿè®¡

â€‹    ![0](https://note.youdao.com/yws/public/resource/5cc182642eb02bc64197788c7722baae/xmlnote/E25CDA3658324BD6B9E13985209D566D/96316)

- MCMN:æœ€å°å…ƒæ•°æ®å®¹é‡
- MCMXï¼šæœ€å¤§å…ƒæ•°æ®å®¹é‡
- MCï¼šå½“å‰å…ƒæ•°æ®ç©ºé—´å¤§å° 
- CCSMNï¼šæœ€å°å‹ç¼©ç±»ç©ºé—´å¤§å°
- CCSMXï¼šæœ€å¤§å‹ç¼©ç±»ç©ºé—´å¤§å°
- CCSCï¼šå½“å‰å‹ç¼©ç±»ç©ºé—´å¤§å°
- YGCï¼šå¹´è½»ä»£åƒåœ¾å›æ”¶æ¬¡æ•°
- FGCï¼šè€å¹´ä»£åƒåœ¾å›æ”¶æ¬¡æ•°
- FGCTï¼šè€å¹´ä»£åƒåœ¾å›æ”¶æ¶ˆè€—æ—¶é—´
- GCTï¼šåƒåœ¾å›æ”¶æ¶ˆè€—æ€»æ—¶é—´

â€‹    ![0](https://note.youdao.com/yws/public/resource/5cc182642eb02bc64197788c7722baae/xmlnote/A4241648D94C49E994C970E5C2FA9EED/96321)

- S0ï¼šå¹¸å­˜1åŒºå½“å‰ä½¿ç”¨æ¯”ä¾‹
- S1ï¼šå¹¸å­˜2åŒºå½“å‰ä½¿ç”¨æ¯”ä¾‹
- Eï¼šä¼Šç”¸å›­åŒºä½¿ç”¨æ¯”ä¾‹
- Oï¼šè€å¹´ä»£ä½¿ç”¨æ¯”ä¾‹
- Mï¼šå…ƒæ•°æ®åŒºä½¿ç”¨æ¯”ä¾‹
- CCSï¼šå‹ç¼©ä½¿ç”¨æ¯”ä¾‹
- YGCï¼šå¹´è½»ä»£åƒåœ¾å›æ”¶æ¬¡æ•°
- FGCï¼šè€å¹´ä»£åƒåœ¾å›æ”¶æ¬¡æ•°
- FGCTï¼šè€å¹´ä»£åƒåœ¾å›æ”¶æ¶ˆè€—æ—¶é—´
- GCTï¼šåƒåœ¾å›æ”¶æ¶ˆè€—æ€»æ—¶é—´

**JVMè¿è¡Œæƒ…å†µé¢„ä¼°**

ç”¨ jstat gc -pid å‘½ä»¤å¯ä»¥è®¡ç®—å‡ºå¦‚ä¸‹ä¸€äº›å…³é”®æ•°æ®ï¼Œæœ‰äº†è¿™äº›æ•°æ®å°±å¯ä»¥é‡‡ç”¨ä¹‹å‰ä»‹ç»è¿‡çš„ä¼˜åŒ–æ€è·¯ï¼Œå…ˆç»™è‡ªå·±çš„ç³»ç»Ÿè®¾ç½®ä¸€äº›åˆå§‹æ€§çš„JVMå‚æ•°ï¼Œæ¯”å¦‚å †å†…å­˜å¤§å°ï¼Œå¹´è½»ä»£å¤§å°ï¼ŒEdenå’ŒSurvivorçš„æ¯”ä¾‹ï¼Œè€å¹´ä»£çš„å¤§å°ï¼Œå¤§å¯¹è±¡çš„é˜ˆå€¼ï¼Œå¤§é¾„å¯¹è±¡è¿›å…¥è€å¹´ä»£çš„é˜ˆå€¼ç­‰ã€‚

**å¹´è½»ä»£å¯¹è±¡å¢é•¿çš„é€Ÿç‡**

å¯ä»¥æ‰§è¡Œå‘½ä»¤ jstat -gc pid 1000 10 (æ¯éš”1ç§’æ‰§è¡Œ1æ¬¡å‘½ä»¤ï¼Œå…±æ‰§è¡Œ10æ¬¡)ï¼Œé€šè¿‡è§‚å¯ŸEU(edenåŒºçš„ä½¿ç”¨)æ¥ä¼°ç®—æ¯ç§’edenå¤§æ¦‚æ–°å¢å¤šå°‘å¯¹è±¡ï¼Œå¦‚æœç³»ç»Ÿè´Ÿè½½ä¸é«˜ï¼Œå¯ä»¥æŠŠé¢‘ç‡1ç§’æ¢æˆ1åˆ†é’Ÿï¼Œç”šè‡³10åˆ†é’Ÿæ¥è§‚å¯Ÿæ•´ä½“æƒ…å†µã€‚æ³¨æ„ï¼Œä¸€èˆ¬ç³»ç»Ÿå¯èƒ½æœ‰é«˜å³°æœŸå’Œæ—¥å¸¸æœŸï¼Œæ‰€ä»¥éœ€è¦åœ¨ä¸åŒçš„æ—¶é—´åˆ†åˆ«ä¼°ç®—ä¸åŒæƒ…å†µä¸‹å¯¹è±¡å¢é•¿é€Ÿç‡ã€‚

**Young GCçš„è§¦å‘é¢‘ç‡å’Œæ¯æ¬¡è€—æ—¶**

çŸ¥é“å¹´è½»ä»£å¯¹è±¡å¢é•¿é€Ÿç‡æˆ‘ä»¬å°±èƒ½æ¨æ ¹æ®edenåŒºçš„å¤§å°æ¨ç®—å‡ºYoung GCå¤§æ¦‚å¤šä¹…è§¦å‘ä¸€æ¬¡ï¼ŒYoung GCçš„å¹³å‡è€—æ—¶å¯ä»¥é€šè¿‡ YGCT/YGC å…¬å¼ç®—å‡ºï¼Œæ ¹æ®ç»“æœæˆ‘ä»¬å¤§æ¦‚å°±èƒ½çŸ¥é“**ç³»ç»Ÿå¤§æ¦‚å¤šä¹…ä¼šå› ä¸ºYoung GCçš„æ‰§è¡Œè€Œå¡é¡¿å¤šä¹…ã€‚**

**æ¯æ¬¡Young GCåæœ‰å¤šå°‘å¯¹è±¡å­˜æ´»å’Œè¿›å…¥è€å¹´ä»£**

è¿™ä¸ªå› ä¸ºä¹‹å‰å·²ç»å¤§æ¦‚çŸ¥é“Young GCçš„é¢‘ç‡ï¼Œå‡è®¾æ˜¯æ¯5åˆ†é’Ÿä¸€æ¬¡ï¼Œé‚£ä¹ˆå¯ä»¥æ‰§è¡Œå‘½ä»¤ jstat -gc pid 300000 10 ï¼Œè§‚å¯Ÿæ¯æ¬¡ç»“æœedenï¼Œsurvivorå’Œè€å¹´ä»£ä½¿ç”¨çš„å˜åŒ–æƒ…å†µï¼Œåœ¨æ¯æ¬¡gcåedenåŒºä½¿ç”¨ä¸€èˆ¬ä¼šå¤§å¹…å‡å°‘ï¼Œsurvivorå’Œè€å¹´ä»£éƒ½æœ‰å¯èƒ½å¢é•¿ï¼Œè¿™äº›å¢é•¿çš„å¯¹è±¡å°±æ˜¯æ¯æ¬¡Young GCåå­˜æ´»çš„å¯¹è±¡ï¼ŒåŒæ—¶è¿˜å¯ä»¥çœ‹å‡ºæ¯æ¬¡Young GCåè¿›å»è€å¹´ä»£å¤§æ¦‚å¤šå°‘å¯¹è±¡ï¼Œä»è€Œå¯ä»¥æ¨ç®—å‡º**è€å¹´ä»£å¯¹è±¡å¢é•¿é€Ÿç‡ã€‚**

**Full GCçš„è§¦å‘é¢‘ç‡å’Œæ¯æ¬¡è€—æ—¶**

çŸ¥é“äº†è€å¹´ä»£å¯¹è±¡çš„å¢é•¿é€Ÿç‡å°±å¯ä»¥æ¨ç®—å‡ºFull GCçš„è§¦å‘é¢‘ç‡äº†ï¼ŒFull GCçš„æ¯æ¬¡è€—æ—¶å¯ä»¥ç”¨å…¬å¼ FGCT/FGC è®¡ç®—å¾—å‡ºã€‚

**ä¼˜åŒ–æ€è·¯**å…¶å®ç®€å•æ¥è¯´å°±æ˜¯å°½é‡è®©æ¯æ¬¡Young GCåçš„å­˜æ´»å¯¹è±¡å°äºSurvivoråŒºåŸŸçš„50%ï¼Œéƒ½ç•™å­˜åœ¨å¹´è½»ä»£é‡Œã€‚å°½é‡åˆ«è®©å¯¹è±¡è¿›å…¥è€å¹´ä»£ã€‚å°½é‡å‡å°‘Full GCçš„é¢‘ç‡ï¼Œé¿å…é¢‘ç¹Full GCå¯¹JVMæ€§èƒ½çš„å½±å“ã€‚

**ç³»ç»Ÿé¢‘ç¹Full GCå¯¼è‡´ç³»ç»Ÿå¡é¡¿æ˜¯æ€ä¹ˆå›äº‹**

- æœºå™¨é…ç½®ï¼š2æ ¸4G
- JVMå†…å­˜å¤§å°ï¼š2G
- ç³»ç»Ÿè¿è¡Œæ—¶é—´ï¼š7å¤©
- æœŸé—´å‘ç”Ÿçš„Full GCæ¬¡æ•°å’Œè€—æ—¶ï¼š500å¤šæ¬¡ï¼Œ200å¤šç§’
- æœŸé—´å‘ç”Ÿçš„Young GCæ¬¡æ•°å’Œè€—æ—¶ï¼š1ä¸‡å¤šæ¬¡ï¼Œ500å¤šç§’

å¤§è‡´ç®—ä¸‹æ¥æ¯å¤©ä¼šå‘ç”Ÿ70å¤šæ¬¡Full GCï¼Œå¹³å‡æ¯å°æ—¶3æ¬¡ï¼Œæ¯æ¬¡Full GCåœ¨400æ¯«ç§’å·¦å³ï¼›

æ¯å¤©ä¼šå‘ç”Ÿ1000å¤šæ¬¡Young GCï¼Œæ¯åˆ†é’Ÿä¼šå‘ç”Ÿ1æ¬¡ï¼Œæ¯æ¬¡Young GCåœ¨50æ¯«ç§’å·¦å³ã€‚

JVMå‚æ•°è®¾ç½®å¦‚ä¸‹ï¼š

â€‹                -Xms1536M -Xmx1536M -Xmn512M -Xss256K -XX:SurvivorRatio=6  -XX:MetaspaceSize=256M -XX:MaxMetaspaceSize=256M  -XX:+UseParNewGC  -XX:+UseConcMarkSweepGC  -XX:CMSInitiatingOccupancyFraction=75 -XX:+UseCMSInitiatingOccupancyOnly               

â€‹    ![0](https://note.youdao.com/yws/public/resource/5cc182642eb02bc64197788c7722baae/xmlnote/4AD3574884C54C7DBF8836737492178E/96307)

å¤§å®¶å¯ä»¥ç»“åˆ**å¯¹è±¡æŒªåŠ¨åˆ°è€å¹´ä»£é‚£äº›è§„åˆ™**æ¨ç†ä¸‹æˆ‘ä»¬è¿™ä¸ªç¨‹åºå¯èƒ½å­˜åœ¨çš„ä¸€äº›é—®é¢˜

ç»è¿‡åˆ†ææ„Ÿè§‰å¯èƒ½ä¼šç”±äºå¯¹è±¡åŠ¨æ€å¹´é¾„åˆ¤æ–­æœºåˆ¶å¯¼è‡´full gcè¾ƒä¸ºé¢‘ç¹

ä¸ºäº†ç»™å¤§å®¶çœ‹æ•ˆæœï¼Œæˆ‘æ¨¡æ‹Ÿäº†ä¸€ä¸ªç¤ºä¾‹ç¨‹åº(è§è¯¾ç¨‹å¯¹åº”å·¥ç¨‹ä»£ç ï¼šjvm-full-gc)ï¼Œæ‰“å°äº†jstatçš„ç»“æœå¦‚ä¸‹ï¼š

â€‹                jstat -gc 13456 2000 10000              

â€‹    ![0](https://note.youdao.com/yws/public/resource/5cc182642eb02bc64197788c7722baae/xmlnote/CE415B441097490B978044442055038E/96359)

å¯¹äºå¯¹è±¡åŠ¨æ€å¹´é¾„åˆ¤æ–­æœºåˆ¶å¯¼è‡´çš„full gcè¾ƒä¸ºé¢‘ç¹å¯ä»¥å…ˆè¯•ç€ä¼˜åŒ–ä¸‹JVMå‚æ•°ï¼ŒæŠŠå¹´è½»ä»£é€‚å½“è°ƒå¤§ç‚¹ï¼š

â€‹                -Xms1536M -Xmx1536M -Xmn1024M -Xss256K -XX:SurvivorRatio=6  -XX:MetaspaceSize=256M -XX:MaxMetaspaceSize=256M  -XX:+UseParNewGC  -XX:+UseConcMarkSweepGC  -XX:CMSInitiatingOccupancyFraction=92 -XX:+UseCMSInitiatingOccupancyOnly               

â€‹    ![0](https://note.youdao.com/yws/public/resource/5cc182642eb02bc64197788c7722baae/xmlnote/AECFE82FDD864C5AAB6F00E8ADD7BF65/96350)

ä¼˜åŒ–å®Œå‘ç°æ²¡ä»€ä¹ˆå˜åŒ–ï¼Œ**full gcçš„æ¬¡æ•°æ¯”minor gcçš„æ¬¡æ•°è¿˜å¤šäº†**

â€‹    ![0](https://note.youdao.com/yws/public/resource/5cc182642eb02bc64197788c7722baae/xmlnote/AE64076329DD43228B9B6F159074BFAC/96366)

æˆ‘ä»¬å¯ä»¥æ¨æµ‹ä¸‹full gcæ¯”minor gcè¿˜å¤šçš„åŸå› æœ‰å“ªäº›ï¼Ÿ

1ã€å…ƒç©ºé—´ä¸å¤Ÿå¯¼è‡´çš„å¤šä½™full gc

2ã€æ˜¾ç¤ºè°ƒç”¨System.gc()é€ æˆå¤šä½™çš„full gcï¼Œè¿™ç§ä¸€èˆ¬çº¿ä¸Šå°½é‡é€šè¿‡-XX:+DisableExplicitGCå‚æ•°ç¦ç”¨ï¼Œå¦‚æœåŠ ä¸Šäº†è¿™ä¸ªJVMå¯åŠ¨å‚æ•°ï¼Œé‚£ä¹ˆä»£ç ä¸­è°ƒç”¨System.gc()æ²¡æœ‰ä»»ä½•æ•ˆæœ

3ã€è€å¹´ä»£ç©ºé—´åˆ†é…æ‹…ä¿æœºåˆ¶

æœ€å¿«é€Ÿåº¦åˆ†æå®Œè¿™äº›æˆ‘ä»¬æ¨æµ‹çš„åŸå› ä»¥åŠä¼˜åŒ–åï¼Œæˆ‘ä»¬å‘ç°young gcå’Œfull gcä¾ç„¶å¾ˆé¢‘ç¹äº†ï¼Œè€Œä¸”çœ‹åˆ°æœ‰å¤§é‡çš„å¯¹è±¡é¢‘ç¹çš„è¢«æŒªåŠ¨åˆ°è€å¹´ä»£ï¼Œè¿™ç§æƒ…å†µæˆ‘ä»¬å¯ä»¥å€ŸåŠ©jmapå‘½ä»¤å¤§æ¦‚çœ‹ä¸‹æ˜¯ä»€ä¹ˆå¯¹è±¡

â€‹    ![0](https://note.youdao.com/yws/public/resource/5cc182642eb02bc64197788c7722baae/xmlnote/4C7F5860756B4F4B988D54121764E082/96303)

æŸ¥åˆ°äº†æœ‰å¤§é‡Userå¯¹è±¡äº§ç”Ÿï¼Œè¿™ä¸ªå¯èƒ½æ˜¯é—®é¢˜æ‰€åœ¨ï¼Œä½†ä¸ç¡®å®šï¼Œè¿˜å¿…é¡»æ‰¾åˆ°å¯¹åº”çš„ä»£ç ç¡®è®¤ï¼Œå¦‚ä½•å»æ‰¾å¯¹åº”çš„ä»£ç äº†ï¼Ÿ

1ã€ä»£ç é‡Œå…¨æ–‡æœç´¢ç”ŸæˆUserå¯¹è±¡çš„åœ°æ–¹(é€‚åˆåªæœ‰å°‘æ•°å‡ å¤„åœ°æ–¹çš„æƒ…å†µ)

2ã€å¦‚æœç”ŸæˆUserå¯¹è±¡çš„åœ°æ–¹å¤ªå¤šï¼Œæ— æ³•å®šä½å…·ä½“ä»£ç ï¼Œæˆ‘ä»¬å¯ä»¥åŒæ—¶åˆ†æä¸‹å ç”¨cpuè¾ƒé«˜çš„çº¿ç¨‹ï¼Œä¸€èˆ¬æœ‰å¤§é‡å¯¹è±¡ä¸æ–­äº§ç”Ÿï¼Œå¯¹åº”çš„æ–¹æ³•ä»£ç è‚¯å®šä¼šè¢«é¢‘ç¹è°ƒç”¨ï¼Œå ç”¨çš„cpuå¿…ç„¶è¾ƒé«˜

å¯ä»¥ç”¨ä¸Šé¢è®²è¿‡çš„jstackæˆ–jvisualvmæ¥å®šä½cpuä½¿ç”¨è¾ƒé«˜çš„ä»£ç ï¼Œæœ€ç»ˆå®šä½åˆ°çš„ä»£ç å¦‚ä¸‹ï¼š

â€‹                import java.util.ArrayList; @RestController public class IndexController {     @RequestMapping("/user/process")    public String processUserData() throws InterruptedException {        ArrayList<User> users = queryUsers();         for (User user: users) {            //TODO ä¸šåŠ¡å¤„ç†            System.out.println("user:" + user.toString());        }        return "end";    }     /**     * æ¨¡æ‹Ÿæ‰¹é‡æŸ¥è¯¢ç”¨æˆ·åœºæ™¯     * @return     */    private ArrayList<User> queryUsers() {        ArrayList<User> users = new ArrayList<>();        for (int i = 0; i < 5000; i++) {            users.add(new User(i,"zhuge"));        }        return users;    } }              

åŒæ—¶ï¼Œjavaçš„ä»£ç ä¹Ÿæ˜¯éœ€è¦ä¼˜åŒ–çš„ï¼Œä¸€æ¬¡æŸ¥è¯¢å‡º500Mçš„å¯¹è±¡å‡ºæ¥ï¼Œæ˜æ˜¾ä¸åˆé€‚ï¼Œè¦æ ¹æ®ä¹‹å‰è¯´çš„å„ç§åŸåˆ™å°½é‡ä¼˜åŒ–åˆ°åˆé€‚çš„å€¼ï¼Œå°½é‡æ¶ˆé™¤è¿™ç§æœç”Ÿå¤•æ­»çš„å¯¹è±¡å¯¼è‡´çš„full gc

**å†…å­˜æ³„éœ²åˆ°åº•æ˜¯æ€ä¹ˆå›äº‹**

å†ç»™å¤§å®¶è®²ä¸€ç§æƒ…å†µï¼Œä¸€èˆ¬ç”µå•†æ¶æ„å¯èƒ½ä¼šä½¿ç”¨å¤šçº§ç¼“å­˜æ¶æ„ï¼Œå°±æ˜¯redisåŠ ä¸ŠJVMçº§ç¼“å­˜ï¼Œå¤§å¤šæ•°åŒå­¦å¯èƒ½ä¸ºäº†å›¾æ–¹ä¾¿å¯¹äºJVMçº§ç¼“å­˜å°±ç®€å•ä½¿ç”¨ä¸€ä¸ªhashmapï¼Œäºæ˜¯ä¸æ–­å¾€é‡Œé¢æ”¾ç¼“å­˜æ•°æ®ï¼Œä½†æ˜¯å¾ˆå°‘è€ƒè™‘è¿™ä¸ªmapçš„å®¹é‡é—®é¢˜ï¼Œç»“æœè¿™ä¸ªç¼“å­˜mapè¶Šæ¥è¶Šå¤§ï¼Œä¸€ç›´å ç”¨ç€è€å¹´ä»£çš„å¾ˆå¤šç©ºé—´ï¼Œæ—¶é—´é•¿äº†å°±ä¼šå¯¼è‡´full gcéå¸¸é¢‘ç¹ï¼Œè¿™å°±æ˜¯ä¸€ç§å†…å­˜æ³„æ¼ï¼Œå¯¹äºä¸€äº›è€æ—§æ•°æ®æ²¡æœ‰åŠæ—¶æ¸…ç†å¯¼è‡´ä¸€ç›´å ç”¨ç€å®è´µçš„å†…å­˜èµ„æºï¼Œæ—¶é—´é•¿äº†é™¤äº†å¯¼è‡´full gcï¼Œè¿˜æœ‰å¯èƒ½å¯¼è‡´OOMã€‚

è¿™ç§æƒ…å†µå®Œå…¨å¯ä»¥è€ƒè™‘é‡‡ç”¨ä¸€äº›æˆç†Ÿçš„JVMçº§ç¼“å­˜æ¡†æ¶æ¥è§£å†³ï¼Œæ¯”å¦‚ehcacheç­‰è‡ªå¸¦ä¸€äº›LRUæ•°æ®æ·˜æ±°ç®—æ³•çš„æ¡†æ¶æ¥ä½œä¸ºJVMçº§çš„ç¼“å­˜ã€‚
